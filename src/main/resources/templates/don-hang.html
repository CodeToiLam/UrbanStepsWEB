<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${title} ?: #{order.history}">Đơn hàng của tôi</title>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/order.css}" />
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="order-page">
            <!-- Thông báo -->
            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
            
            <!-- Section cho user đã đăng nhập -->
            <div sec:authorize="isAuthenticated()">
                <div class="welcome-section mb-3">
                    <h1 class="h4 fw-bold mb-1" th:text="#{order.history}">Đơn hàng của tôi</h1>
                    <p class="text-muted mb-0" style="font-size:.85rem" th:utext="${customerName != null && !#strings.isEmpty(customerName) ? 'Xin chào <strong>' + customerName + '</strong>! ' + ' ' + #messages.msgOrNull('order.history') : #messages.msgOrNull('order.history')}">Lịch sử đơn hàng</p>
                </div>
                
                <div class="orders-section">
                    <div class="orders-header d-flex flex-wrap align-items-center gap-3 mb-3">
                        <h2 class="mb-0"><i class="bi bi-box-seam"></i> <span th:text="#{order.history}">Danh sách đơn hàng</span></h2>
                        <div class="status-filters nav nav-pills" role="tablist">
                            <a class="nav-link active" href="#" data-status="all" th:text="#{filter.all.status}">Tất cả</a>
                            <a class="nav-link" href="#" data-status="0" th:text="#{status.pending}"></a>
                            <a class="nav-link" href="#" data-status="1" th:text="#{status.processing}"></a>
                            <a class="nav-link" href="#" data-status="2" th:text="#{status.deliver}"></a>
                            <a class="nav-link" href="#" data-status="3" th:text="#{order.status.completed}">Hoàn thành</a>
                            <a class="nav-link" href="#" data-status="4" th:text="#{status.cancelled}">Đã hủy</a>
                                <a class="nav-link" href="#" data-status="6" th:text="#{status.return}">Trả hàng</a>
                                <a class="nav-link" href="#" data-status="7" th:text="#{status.Returnprocessing}">Xử lý trả hàng</a>
                                <a class="nav-link" href="#" data-status="8" th:text="#{status.returnfailed}">Trả hàng thất bại</a>
                        </div>
                        <div id="ordersCount" class="orders-summary-count ms-auto" th:text="${orders != null}? ${orders.size()} + ' ' + #{order.history} : '0'"></div>
                    </div>

                    <div th:if="${orders != null && !orders.isEmpty()}" class="orders-list" id="ordersList">
                        <div th:each="order : ${orders}" class="order-card" th:attr="data-status=${order.trangThai}">
                            <div class="order-meta">
                                <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                                                <a th:href="${isLoggedIn} ? @{/don-hang/chi-tiet/{id}(id=${order.id})} : @{/don-hang/chi-tiet-ma/{ma}(ma=${order.maHoaDon}, sdt=${lookupPhone})}"
                                                    class="fw-semibold text-decoration-none" th:text="${order.maHoaDon}">HD001</a>
                                    <span class="order-status-badge" th:classappend="' status-' + ${order.trangThai}" th:text="${order.getTrangThaiText()}">Trạng thái</span>
                                </div>
                                <div class="small text-muted"><span th:text="#{order.date}">Ngày đặt</span>: <span th:text="${order.createAt != null ? #temporals.format(order.createAt,'dd/MM/yyyy HH:mm') : ''}"></span></div>
                                <div class="small"><span th:text="#{order.total}">Tổng</span>: <span th:text="${#numbers.formatDecimal(order.tongThanhToan,0,0)} + 'đ'"></span></div>
                            </div>
                            <div class="order-actions text-end">
                                          <a th:href="${isLoggedIn} ? @{/don-hang/chi-tiet/{id}(id=${order.id})} : @{/don-hang/chi-tiet-ma/{ma}(ma=${order.maHoaDon}, sdt=${lookupPhone})}"
                                              class="btn btn-sm btn-outline-secondary" th:text="#{order.view.detail}">Chi tiết</a>
                                <form th:if="${order.trangThai == 0 || order.trangThai == 1}" th:action="@{/don-hang/huy/{id}(id=${order.id})}" method="post" class="d-inline" onsubmit="return confirm('Bạn có chắc muốn hủy đơn hàng này?')">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-x-circle"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div th:if="${orders == null || orders.isEmpty()}" class="empty-state">
                        <i class="bi bi-box-seam"></i>
                        <h3 class="h5" th:text="#{order.empty}">Chưa có đơn hàng nào</h3>
                        <p class="mb-3"><span th:text="#{order.empty}"></span></p>
                        <a href="/san-pham" class="btn-login">
                            <span th:text="#{order.go.shopping}">Mua sắm ngay</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Section cho user chưa đăng nhập -->
            <div sec:authorize="!isAuthenticated()">
                <div class="login-prompt">
                    <h2><i class="bi bi-person-check"></i> <span th:text="#{order.view.detail}">Đăng nhập để xem đơn hàng</span></h2>
                    <p class="mb-2" th:text="#{order.history}">Đăng nhập để xem danh sách đơn hàng của bạn hoặc tra cứu đơn hàng bằng mã đơn hàng và số điện thoại.</p>
                    <a href="/dang-nhap" class="btn-login">
                        <i class="bi bi-box-arrow-in-right"></i> <span th:text="#{nav.login}">Đăng nhập ngay</span>
                    </a>
                </div>
                
                <div class="search-section">
              <h2><i class="bi bi-search"></i> <span th:text="#{search.title}">Tra cứu đơn hàng</span></h2>
              <p class="small text-muted mb-3" th:text="#{search.results}">Để bảo mật, vui lòng nhập cả mã đơn hàng và số điện thoại để tra cứu.</p>
                    <form th:action="@{/don-hang/tra-cuu}" method="post" class="search-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-2">
                     <label for="maHoaDon" class="mb-1 small text-muted"><i class="bi bi-receipt me-1"></i> <span th:text="#{order.code}">Mã đơn hàng</span> *</label>
                                    <input type="text" id="maHoaDon" name="maHoaDon" class="form-control"
                         th:placeholder="#{order.code}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-2">
                     <label for="soDienThoai" class="mb-1 small text-muted"><i class="bi bi-telephone me-1"></i> <span th:text="#{customer.phone}">Số điện thoại</span> *</label>
                                    <input type="tel" id="soDienThoai" name="sdt" class="form-control"
                         th:placeholder="#{customer.phone}" required pattern="[0-9+ ]{9,15}">
                                </div>
                            </div>
                        </div>
               <button type="submit" class="btn-primary"><i class="bi bi-search"></i> <span th:text="#{search.title}">Tra cứu đơn hàng</span></button>
                    </form>
                </div>
                
                     <div th:if="${orders != null && !orders.isEmpty()}" class="guest-orders">
                    <div class="mb-2 fw-semibold"><span th:text="#{order.code}">Mã đơn hàng</span>: <span th:text="${lookupOrderCode}"></span></div>
                    <div th:each="order : ${orders}" class="order-card">
                        <div class="order-meta">
                            <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                                          <a class="fw-semibold text-decoration-none"
                                              th:href="@{/don-hang/chi-tiet-ma/{ma}(ma=${order.maHoaDon}, sdt=${lookupPhone})}"
                                              th:text="${order.maHoaDon}">HD001</a>
                                <span class="order-status-badge" th:classappend="' status-' + ${order.trangThai}" th:text="${order.getTrangThaiText()}">Trạng thái</span>
                            </div>
                            <div class="small text-muted"><span th:text="#{order.date}">Ngày đặt</span>: <span th:text="${order.createAt != null ? #temporals.format(order.createAt,'dd/MM/yyyy HH:mm') : ''}"></span></div>
                            <div class="small"><span th:text="#{order.total}">Tổng tiền</span>: <span th:text="${#numbers.formatDecimal(order.tongThanhToan,0,0)} + 'đ'"></span></div>
                        </div>
                                <div class="order-actions text-end">
                                     <a class="btn btn-sm btn-outline-secondary"
                                         th:href="@{/don-hang/chi-tiet-ma/{ma}(ma=${order.maHoaDon}, sdt=${lookupPhone})}" th:text="#{order.view.detail}">Chi tiết</a>
                                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<th:block layout:fragment="extra-js">
    <script th:src="@{/js/order.js}"></script>
</th:block>
</html>
