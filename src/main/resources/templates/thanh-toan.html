<!DOCTYPE html>
<html th:lang="${#locale}" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title layout:fragment="title" th:text="#{checkout.title}">Thanh toán - UrbanSteps</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/gio-hang.css}">
        <link rel="stylesheet" th:href="@{/css/checkout.css}">
        <script th:src="@{/js/checkout-fix.js}"></script>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="container py-4">
        <h2 class="mb-4 fw-bold" th:text="#{checkout.confirm}">Xác nhận đơn hàng</h2>

        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <form id="checkoutForm" class="needs-validation" novalidate>
            <div class="card mb-4">
                <div class="card-header bg-light fw-bold" th:text="#{checkout.cart.title}">1. Thông tin sản phẩm</div>
                <div class="card-body p-0">
                    <div th:if="${gioHang != null and !gioHang.items.empty}">
                        <table class="table table-bordered m-0">
                            <thead class="table-light text-center">
                            <tr>
                                <th th:text="#{checkout.table.product}">Sản phẩm</th>
                                <th th:text="#{product.size}">Kích cỡ</th>
                                <th th:text="#{product.color}">Màu sắc</th>
                                <th th:text="#{checkout.table.quantity}">Số lượng</th>
                                <th th:text="#{checkout.table.unitPrice}">Đơn giá</th>
                                <th th:text="#{checkout.table.lineTotal}">Thành tiền</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${gioHang.items}" th:attr="data-item-id=${item.id}">
                                <td th:text="${item.tenSanPham}">Tên sản phẩm</td>
                                <td class="text-center" th:text="${item.kichCo}">40</td>
                                <td class="text-center" th:text="${item.mauSac}">Đen</td>
                                <td class="text-center" th:text="${item.soLuong}">1</td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(item.giaTaiThoidiem, 0, 0) + 'đ'}">1,000,000đ</td>
                                <td class="text-end">
                                    <div class="item-total-cell">
                                        <span class="item-line-total"
                                              th:attr="data-item-id=${item.id}"
                                              th:data-original-total="${item.tongGia}"
                                              th:text="${#numbers.formatDecimal(item.tongGia, 0, 0) + 'đ'}">1,000,000đ</span>
                                        <div class="item-line-discount text-success small" style="display:none;"
                                             th:attr="data-item-id=${item.id}">
                                            -0đ
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 text-end">
                        <strong th:text="#{checkout.total} + ':'">Tổng tiền: </strong>
                        <span class="text-danger fs-5 fw-bold" th:text="${#numbers.formatDecimal(gioHang.tongTien,0,0)} + 'đ'">0đ</span>
                        <div class="mt-2">
                            <strong th:text="#{checkout.discount} + ':'">Giảm giá: </strong>
                            <span id="discountAmount" class="fs-5" th:text="${discountedTotal != null ? (#numbers.formatDecimal(gioHang.tongTien - discountedTotal,0,0) + 'đ') : '0đ'}"></span>
                        </div>
                        <div class="mt-2">
                            <strong th:text="#{checkout.payable} + ':'">Tổng thanh toán: </strong>
                            <span id="finalTotal" class="text-danger fs-5 fw-bold" th:text="${discountedTotal != null ? (#numbers.formatDecimal(discountedTotal,0,0) + 'đ') : (#numbers.formatDecimal(gioHang.tongTien,0,0) + 'đ')}"></span>
                        </div>
                        <div class="mt-3">
                            <label class="form-label" th:text="#{checkout.promo.label}">Mã khuyến mãi</label>
                            <div class="input-group">
                                <input type="text" name="maGiamGia" class="form-control" th:placeholder="#{checkout.promo.placeholder}" placeholder="Nhập mã giảm giá nếu có">
                                <select id="voucherCode" class="form-select" style="max-width: 200px;">
                                    <option value="">Chọn mã khuyến mãi</option>
                                    <option th:each="voucher : ${publicVouchers}" th:value="${voucher.maPhieuGiamGia}"
                                            th:text="${voucher.maPhieuGiamGia} + ' - ' + ${voucher.moTa}"></option>
                                </select>
                                <button id="openVoucherModalBtn" class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#voucherModal" th:text="#{checkout.chooseVoucher}">Chọn mã</button>
                                <button id="applyVoucherBtn" class="btn btn-secondary" type="button" data-exclusive="1" th:text="#{checkout.apply}">Áp dụng</button>
                            </div>
                            <div id="voucherMessage" class="text-success mt-2" style="display: none;"></div>
                            <div id="voucherError" class="text-danger mt-2" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                    <span th:text="#{checkout.shipping.title}">2. Thông tin giao hàng</span>
                    <a href="/tai-khoan#address" class="small text-decoration-none" th:text="#{checkout.manageAddresses}">Quản lý địa chỉ</a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hoTen" class="form-label"><span th:text="#{checkout.fullName}">Họ và tên</span> <span class="text-danger">*</span></label>
                            <input type="text" id="hoTen" name="hoTen" class="form-control" required th:value="${accountFullName} ?: ''">
                            <div class="invalid-feedback" th:text="#{validation.fullName}">Vui lòng nhập họ tên</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sdt" class="form-label"><span th:text="#{checkout.phone}">Số điện thoại</span> <span class="text-danger">*</span></label>
                            <input type="tel" id="sdt" name="sdt" class="form-control" required pattern="[0-9+ ]{10,15}" th:value="${accountPhone} ?: ''">
                            <div class="invalid-feedback" th:text="#{validation.phone}">Vui lòng nhập số điện thoại hợp lệ (10-15 số)</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label" th:text="#{checkout.emailOptional}">Email (không bắt buộc)</label>
                        <input type="email" id="email" name="email" class="form-control" th:value="${accountEmail} ?: ''">
                        <div class="invalid-feedback" th:text="#{validation.email}">Email không hợp lệ</div>
                    </div>

                    <div id="savedAddressesContainer"></div>
                    <input type="hidden" id="selectedAddressId" name="selectedAddressId" value="" />

                    <div id="manualAddressFields" class="manual-address-section">
                        <h6>Thông tin giao hàng</h6>
                        <div class="address-selector">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="province" class="form-label"><span th:text="#{checkout.province}">Tỉnh/Thành phố</span> <span class="text-danger">*</span></label>
                                    <select id="province" name="tinhThanh" class="form-select" required>
                                        <option value="" th:text="#{checkout.selectProvince}">Chọn tỉnh/thành phố</option>
                                    </select>
                                    <div class="invalid-feedback" th:text="#{validation.province}">Vui lòng chọn tỉnh/thành phố</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="district" class="form-label"><span th:text="#{checkout.district}">Quận/Huyện</span> <span class="text-danger">*</span></label>
                                    <select id="district" name="quanHuyen" class="form-select" required disabled>
                                        <option value="" th:text="#{checkout.selectDistrict}">Chọn quận/huyện</option>
                                    </select>
                                    <div class="invalid-feedback" th:text="#{validation.district}">Vui lòng chọn quận/huyện</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="ward" class="form-label"><span th:text="#{checkout.ward}">Phường/Xã</span> <span class="text-danger">*</span></label>
                                    <select id="ward" name="phuongXa" class="form-select" required disabled>
                                        <option value="" th:text="#{checkout.selectWard}">Chọn phường/xã</option>
                                    </select>
                                    <div class="invalid-feedback" th:text="#{validation.ward}">Vui lòng chọn phường/xã</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="diaChiGiaoHang" class="form-label"><span th:text="#{checkout.addressDetail}">Địa chỉ cụ thể (số nhà, tên đường)</span> <span class="text-danger">*</span></label>
                            <textarea id="diaChiGiaoHang" name="diaChiGiaoHang" class="form-control" rows="2" required></textarea>
                            <div class="invalid-feedback" th:text="#{validation.addressDetail}">Vui lòng nhập địa chỉ cụ thể</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ghiChu" class="form-label" th:text="#{checkout.noteOptional}">Ghi chú (không bắt buộc)</label>
                        <textarea id="ghiChu" name="ghiChu" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light fw-bold" th:text="#{checkout.payment.title}">3. Phương thức thanh toán</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label" th:text="#{checkout.chooseMethod}">Chọn phương thức</label>
                        <select name="phuongThucThanhToan" class="form-select" required>
                            <option value="1" th:text="#{checkout.cod}">Thanh toán tiền mặt khi nhận hàng</option>
                            <option value="2" th:text="#{checkout.bankTransfer}">Chuyển khoản qua QR ngân hàng</option>
                        </select>
                        <div class="mb-3" id="qr-section" style="display:none;">
                            <label class="form-label" th:text="#{checkout.bank.qrLabel}">Quét mã QR để chuyển khoản Vietcombank</label>
                            <div class="d-flex flex-column align-items-center">
                                <img id="qr-image" src="/images/qr-code.jpg" alt="QR chuyển khoản Vietcombank" style="width:200px;height:200px;object-fit:contain;" />
                                <div class="mt-2"><span th:text="#{checkout.bank.accountNumber}">Số tài khoản</span>: <strong>1042116409</strong></div>
                                <div class=""><span th:text="#{checkout.bank.accountName}">Chủ tài khoản</span>: <strong>PHAM NHU SON TUNG</strong></div>
                                <div class=""><span th:text="#{checkout.bank.bankName}">Ngân hàng</span>: Vietcombank - Trụ sở CN Chương Dương</div>
                                <div class="text-muted"><span th:text="#{checkout.bank.transferContent}">Nội dung chuyển khoản</span>: <span id="qr-content">Thanh toán UrbanSteps</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="ghiChu" class="form-label" th:text="#{checkout.note}">Ghi chú (nếu có)</label>
                        <textarea id="ghiChu" name="ghiChu" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <a th:href="@{/gio-hang}" class="btn btn-outline-secondary" th:text="#{checkout.backToCart}">← Quay lại giỏ hàng</a>
                <div>
                    <input type="hidden" name="buyNow" th:value="${buyNow} ?: false" />
                    <input type="hidden" name="buyNowItemId" th:value="${buyNowItemId}" />
                    <input type="hidden" name="buyNowQuantity" th:value="${buyNowQuantity}" />
                    <button type="submit" id="placeOrderBtn" class="btn btn-danger btn-lg" th:text="#{checkout.placeOrder}">Đặt hàng ngay</button>
                </div>
            </div>
        </form>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:src="@{/js/checkout-core.js}"></script>
    <script th:src="@{/js/checkout-address-new.js}"></script>
    <script th:src="@{/js/thanh-toan.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const openVoucherModalBtn = document.getElementById('openVoucherModalBtn');
            const modalEl = document.getElementById('voucherModal');
            const voucherList = modalEl.querySelector('.modal-body .list-group');
            const voucherInput = document.querySelector('input[name="maGiamGia"]');
            const voucherSelect = document.getElementById('voucherCode');
            const resetVoucherBtn = document.getElementById('resetVoucherBtn');
            const totalAmount = parseFloat(document.querySelector('.text-danger.fs-5.fw-bold').textContent.replace(/[^0-9]/g, '') || 0);
            const originalTotal = totalAmount; // Lưu tổng tiền ban đầu
            const discountAmountEl = document.getElementById('discountAmount');
            const finalTotalEl = document.getElementById('finalTotal');
            const voucherMessage = document.getElementById('voucherMessage');
            const voucherError = document.getElementById('voucherError');

            // Hàm reset về giá ban đầu
            function resetVoucher() {
                // Reset tổng thanh toán về giá ban đầu
                finalTotalEl.textContent = formatCurrency(originalTotal);
                // Reset giảm giá về 0
                discountAmountEl.textContent = formatCurrency(0);
                // Ẩn các giảm giá từng sản phẩm
                document.querySelectorAll('.item-line-discount').forEach(el => {
                    el.style.display = 'none';
                    el.textContent = '-0đ';
                });
                // Xóa thông báo
                voucherMessage.style.display = 'none';
                voucherError.style.display = 'none';
                // Reset input và dropdown
                voucherInput.value = '';
                voucherSelect.value = '';
            }

            // Kiểm tra trạng thái ban đầu
            if (!voucherInput.value && !voucherSelect.value) {
                resetVoucher(); // Reset giá gốc nếu không có mã nào được chọn
            }

            // Tải danh sách mã khuyến mãi cho modal
            async function loadVouchers() {
                try {
                    const response = await fetch('/checkout/api/public-vouchers', {
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                        }
                    });
                    console.log('API /checkout/api/public-vouchers response:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const vouchers = await response.json();
                    console.log('Vouchers received:', vouchers);

                    // Điền danh sách mã vào modal
                    voucherList.innerHTML = '';
                    if (vouchers.length === 0) {
                        voucherList.innerHTML = '<div class="text-muted">Hiện chưa có mã nào.</div>';
                    } else {
                        vouchers.forEach(v => {
                            const isApplicable = v.donToiThieu ? totalAmount >= parseFloat(v.donToiThieu) : true;
                            const item = document.createElement('div');
                            item.className = 'list-group-item d-flex justify-content-between align-items-center';
                            item.innerHTML = `
                                <div>
                                    <div class="fw-bold">${v.maPhieuGiamGia}</div>
                                    <div class="small text-muted">${v.moTa || ''}</div>
                                    <div class="small">
                                        ${v.donToiThieu ? `Đơn tối thiểu: ${formatCurrency(parseFloat(v.donToiThieu))}` : ''}
                                        ${v.giamToiDa ? ` • Giảm tối đa: ${formatCurrency(parseFloat(v.giamToiDa))}` : ''}
                                        • HSD: ${new Date(v.ngayKetThuc).toLocaleDateString('vi-VN')}
                                        ${!isApplicable ? '<div class="text-danger small">Đơn hàng chưa đủ giá trị tối thiểu</div>' : ''}
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-code="${v.maPhieuGiamGia}" onclick="navigator.clipboard.writeText(this.dataset.code)">Copy</button>
                                    <button type="button" class="btn btn-sm btn-primary use-voucher-btn" data-code="${v.maPhieuGiamGia}" ${!isApplicable ? 'disabled' : ''}>Dùng mã</button>
                                </div>
                            `;
                            voucherList.appendChild(item);
                        });

                        // Gắn sự kiện cho các nút "Dùng mã" trong modal
                        voucherList.querySelectorAll('.use-voucher-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const code = this.dataset.code;
                                voucherInput.value = code;
                                voucherSelect.value = code; // Đồng bộ với dropdown
                                if (typeof applyVoucher === 'function') {
                                    applyVoucher();
                                } else {
                                    console.error('applyVoucher function not found');
                                }
                                bootstrap.Modal.getInstance(modalEl).hide();
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error loading vouchers:', error);
                    voucherList.innerHTML = '<div class="text-danger">Lỗi khi tải mã khuyến mãi</div>';
                }
            }

            // Tải danh sách mã khi trang được tải
            loadVouchers();

            // Mở modal
            if (openVoucherModalBtn && modalEl && window.bootstrap && bootstrap.Modal) {
                openVoucherModalBtn.addEventListener('click', function() {
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                });
            }

            // Xử lý chọn mã từ dropdown
            if (voucherSelect) {
                voucherSelect.addEventListener('change', function() {
                    if (this.value) {
                        voucherInput.value = this.value;
                        if (typeof applyVoucher === 'function') {
                            applyVoucher();
                        } else {
                            console.error('applyVoucher function not found');
                        }
                    } else {
                        resetVoucher();
                    }
                });
            }

            // Xử lý xóa mã từ input
            if (voucherInput) {
                voucherInput.addEventListener('input', function() {
                    if (!this.value) {
                        voucherSelect.value = ''; // Đồng bộ với dropdown
                        resetVoucher();
                    }
                });
            }

            // Xử lý nút "Làm mới"
            if (resetVoucherBtn) {
                resetVoucherBtn.addEventListener('click', function() {
                    resetVoucher();
                });
            }
        });
    </script>
</th:block>

<div class="modal fade" id="voucherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" th:text="#{checkout.modal.title}">Chọn mã khuyến mãi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{checkout.close}">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    window.i18n = Object.assign({}, window.i18n || {}, {
        voucher_selectPrompt: '[[#{voucher.selectPrompt}]]',
        voucher_applySuccess: '[[#{voucher.applySuccess}]]',
        voucher_invalid: '[[#{voucher.invalid}]]',
        voucher_error: '[[#{voucher.error}]]',
        network_error: '[[#{common.networkError}]]',
        place_failed: '[[#{checkout.placeFailed}]]'
    });
</script>
</body>
</html>