<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>

    <title layout:fragment="title"
           th:text="${product != null ? product.tenSanPham : 'Chi tiết sản phẩm'} + ' - UrbanSteps'">Chi tiết sản phẩm -
        UrbanSteps</title>
    <meta charset="UTF-8">
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" href="/css/chi-tiet-san-pham.css">
    </th:block>
</head>

<div layout:fragment="content">
    <div class="container mt-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb custom-breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/}">
                        <i class="bi bi-house-door"></i>
                        <span th:text="#{home.title}"></span>
                    </a>
                </li>

                <li class="breadcrumb-separator">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M6.646 1.646a.5.5 0 0 1 .708 0l4.5 4.5a.5.5 0 0 1 0 .708l-4.5 4.5a.5.5 0 0 1-.708-.708L10.293 6 6.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/san-pham}" th:text="#{spct.detail.namelink}"></a>
                </li>
                <li class="breadcrumb-separator">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M6.646 1.646a.5.5 0 0 1 .708 0l4.5 4.5a.5.5 0 0 1 0 .708l-4.5 4.5a.5.5 0 0 1-.708-.708L10.293 6 6.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${product.tenSanPham}">Chi tiết sản phẩm</li>
            </ol>
            <style>
                .custom-breadcrumb {
                    background: none;
                    padding: 0;
                    margin-bottom: 1rem;
                    font-size: 1.1rem;
                }
                .custom-breadcrumb .breadcrumb-item a {
                    color: #1976d2;
                    text-decoration: underline;
                    font-weight: 500;
                    transition: color 0.2s;
                }
                .custom-breadcrumb .breadcrumb-item a:hover {
                    color: #ff6600;
                    text-decoration: underline;
                }
                .custom-breadcrumb .breadcrumb-separator {
                    display: inline-block;
                    vertical-align: middle;
                    margin: 0 0.3rem;
                }
                .custom-breadcrumb .breadcrumb-item.active {
                    color: #333;
                    font-weight: 600;
                }
            </style>
        </nav>

        <div class="row">
            <!-- Hình ảnh sản phẩm -->
            <div class="col-md-6">
                <div class="product-gallery-container">
                    <!-- Gallery layout: vertical thumbnails + main image -->
                    <div class="gallery-layout" th:if="${productImages != null and !#lists.isEmpty(productImages)}">

                        <!-- Thumbnail column (vertical) -->
                        <div class="thumbnails-column" th:if="${productImages.size() > 1}">
                            <div class="thumbnails-wrapper">
                                <div class="thumbnail-scroll-container" id="thumbnailScrollContainer">
                                    <div th:each="img, imgStat : ${productImages}"
                                         th:class="${imgStat.index == 0 ? 'thumbnail-item active' : 'thumbnail-item'}"
                                         th:data-image="${img.duongDan}"
                                         th:data-index="${imgStat.index}"
                                         onclick="changeMainImage(this)">
                                        <div class="thumbnail-frame">
                                            <img th:src="${img.duongDan}"
                                                 th:alt="${product.tenSanPham + ' - Ảnh ' + (imgStat.count)}"
                                                 class="thumbnail-img"
                                                 onerror="this.style.display='none'; this.parentElement.parentElement.style.display='none'; if(window.updateImageCounter) window.updateImageCounter();">
                                            <div class="thumbnail-overlay">
                                                <div class="thumbnail-number" th:text="${imgStat.count}">1</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Scroll navigation for thumbnails -->
                                <div class="thumbnail-nav" th:if="${productImages.size() > 5}">
                                    <button class="thumb-nav-btn thumb-nav-up" id="thumbNavUp" onclick="scrollThumbnails('up')">
                                        <i class="bi bi-chevron-up"></i>
                                    </button>
                                    <button class="thumb-nav-btn thumb-nav-down" id="thumbNavDown" onclick="scrollThumbnails('down')">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Main image area -->
                        <div class="main-image-area">
                            <div class="main-image-container">
                                <!-- Image loading overlay -->
                                <div class="image-loading-overlay" id="imageLoadingOverlay">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Main product image -->
                                <img id="main-product-image"
                                     th:src="${productImages[0].duongDan}"
                                     th:alt="${product.tenSanPham}"
                                     class="main-product-image"
                                     onerror="this.onerror=null; this.src='/images/no-image.jpg';">

                                <!-- Zoom indicator -->
                                <div class="zoom-indicator">
                                    <i class="bi bi-zoom-in"></i>
                                    <span>Click để phóng to</span>
                                </div>

                                <!-- Navigation dots for mobile -->
                                <div class="image-dots d-md-none" th:if="${productImages.size() > 1}">
                                    <span th:each="img, imgStat : ${productImages}"
                                          th:class="${imgStat.index == 0 ? 'dot active' : 'dot'}"
                                          th:data-index="${imgStat.index}"
                                          onclick="changeMainImage(document.querySelector('[data-index=\'' + this.dataset.index + '\']'))"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fallback for single image or no images -->
                    <div class="single-image-container" th:if="${productImages == null or #lists.isEmpty(productImages) or productImages.size() == 1}">
                        <img id="main-product-image-single"
                             th:if="${productImages != null and !#lists.isEmpty(productImages)}"
                             th:src="${productImages[0].duongDan}"
                             th:alt="${product.tenSanPham}"
                             class="main-product-image"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';">
                        <img th:unless="${productImages != null and !#lists.isEmpty(productImages)}"
                             id="main-product-image-single"
                             th:src="${product.idHinhAnhDaiDien != null ? product.idHinhAnhDaiDien.duongDan : '/images/no-image.jpg'}"
                             th:alt="${product.tenSanPham}"
                             class="main-product-image"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';">
                    </div>
                </div>

                <!-- Image info -->
                <div class="image-info mt-3" th:if="${productImages != null and !#lists.isEmpty(productImages)}">
                    <div class="image-counter" id="imageCounterBlock">
                        <span id="currentImageIndex">1</span> / <span th:text="${productImages.size()}" id="totalImageCount">[[${productImages.size()}]]</span>
                    </div>
                    <div class="image-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openLightbox()" th:if="${productImages.size() > 1}">
                            <i class="bi bi-arrows-fullscreen"></i>
                            <span th:text="#{spct.zoom}"></span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1" onclick="shareImage()">
                            <i class="bi bi-share"></i>
                            <span th:text="#{spct.share}"></span>
                        </button>

                    </div>
                </div>
            </div>

            <!-- Thông tin sản phẩm -->
            <div class="col-md-6">
                <h1 class="product-title" th:text="${product.tenSanPham}">Tên sản phẩm</h1>

            <div class="product-code mb-3">
                <span th:text="#{spct.detail.code}"></span>
                <span th:text="${product.maSanPham}" class="code">SP001</span>
            </div>

        <div class="product-price mb-4">
            <div class="mb-2">
              <span th:if="${product.phanTramGiam != null and product.phanTramGiam > 0}"
                  class="badge rounded-pill bg-danger me-1">SALE -<span th:text="${#numbers.formatDecimal(product.phanTramGiam,0,0)}"></span>%</span>
              <span th:if="${product.luotBan != null and product.luotBan > 0}"
                  class="badge rounded-pill bg-warning text-dark">HOT</span>
            </div>
            <span th:if="${product.phanTramGiam != null and product.phanTramGiam > 0}"
                class="text-muted text-decoration-line-through me-2"
                th:text="${#numbers.formatDecimal(product.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
            <span class="current-price"
                th:text="${(product.phanTramGiam != null and product.phanTramGiam > 0) ?
                         #numbers.formatDecimal(product.giaSauGiam, 0, 'COMMA', 0, 'POINT') + 'đ' :
                         (product.giaBan != null ? #numbers.formatDecimal(product.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ')}">1,200,000đ</span>
        </div>

            <!-- Chọn kích cỡ -->
            <div class="product-size mb-3" th:if="${!kichCos.empty}">
                <h5 th:text="#{spct.size}"></h5>
                <div class="size-options">
                    <div th:each="size : ${kichCos}" class="size-option">
                        <input type="radio" th:id="${'size-' + size}" name="size" th:value="${size}">
                        <label th:for="${'size-' + size}" th:text="${size}">40</label>
                    </div>
                </div>
            </div>

            <!-- Chọn màu sắc -->
            <div class="product-color mb-3" th:if="${!mauSacs.empty}">
                <h5 th:text="#{spct.color}"></h5>
                <div class="color-options">
                    <div th:each="color : ${mauSacs}" class="color-option">
                        <input type="radio" th:id="${'color-' + color}" name="color" th:value="${color}">
                        <label th:for="${'color-' + color}" th:text="${color}">Đen</label>
                    </div>
                </div>
            </div>

            <!-- Hidden input for single color -->
            <!-- Hidden input for single color (giữ lại nếu muốn auto-check) -->
            <!-- Nếu muốn cho phép chọn, có thể bỏ đoạn này hoặc để auto-check khi chỉ có 1 màu -->

            <!-- Số lượng tồn kho -->
            <div class="product-stock mb-3" th:if="${!kichCos.empty && !mauSacs.empty}">
                <span th:text="#{spct.remainingproducts}"> </span>
                <span id="stock-quantity"
                      th:text="${mauSacs.size() == 1 ? 'Vui lòng chọn kích cỡ' : 'Vui lòng chọn kích cỡ và màu sắc'}">
                </span>
            </div>

            <!-- Số lượng mua -->
            <div class="product-quantity mb-3">
                <h5 class="quantity-label" th:text="#{spct.quantity}"></h5>
                <div class="quantity-selector">
                    <button id="decrease-quantity" class="quantity-btn decrease-btn" type="button">
                        <i class="bi bi-dash"></i>
                    </button>
                    <div class="quantity-display">
                        <input type="number" id="quantity" value="1" min="1" class="quantity-input" readonly>
                        <span class="quantity-label-text" th:text="#{spct.sanpham}"></span>
                    </div>
                    <button id="increase-quantity" class="quantity-btn increase-btn" type="button">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Nút thêm vào giỏ hàng -->
            <div class="product-actions mb-4">
                <button id="add-to-cart" class="btn btn-secondary add-to-cart-btn" disabled
                        th:text="${mauSacs.size() == 1 ? 'Chọn kích cỡ' : 'Chọn kích cỡ và màu'}">
                    <i class="bi bi-cart-plus"></i> Chọn kích cỡ và màu
                </button>
                <button id="buy-now" class="btn btn-secondary buy-now-btn" disabled
                        th:text="${mauSacs.size() == 1 ? 'Chọn kích cỡ' : 'Chọn kích cỡ và màu'}">
                    <i class="bi bi-lightning-fill"></i> Chọn kích cỡ và màu
                </button>
            </div>

            <!-- External marketplace buy buttons -->
            <div class="external-buy mb-4" th:if="${product.shopeeUrl != null or product.lazadaUrl != null or product.facebookShopUrl != null}">
                <h5>Mua trên sàn</h5>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <a th:if="${product.shopeeUrl != null}" th:href="${product.shopeeUrl}" target="_blank" class="btn btn-warning">Mua trên Shopee</a>
                    <a th:if="${product.lazadaUrl != null}" th:href="${product.lazadaUrl}" target="_blank" class="btn btn-primary" style="background-color:#1a73e8;">Mua trên Lazada</a>
                    <a th:if="${product.facebookShopUrl != null}" th:href="${product.facebookShopUrl}" target="_blank" class="btn btn-secondary">Facebook Shop</a>
                </div>
            </div>

            <!-- Mô tả sản phẩm -->
            <div class="product-description mb-4" th:if="${product.moTa != null && !product.moTa.empty}">
                <h5 th:text="#{spct.description}"></h5>
                <p th:text="${product.moTa}">Mô tả sản phẩm sẽ hiển thị ở đây...</p>
            </div>

            <!-- Thông tin thương hiệu và xuất xứ -->
            <div class="product-info">
                <div class="info-item" th:if="${product.thuongHieu != null}">
                    <span class="info-label" th:text="#{spct.brand}"></span>
                    <span class="info-value" th:text="${product.thuongHieu.tenThuongHieu}">Nike</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sản phẩm liên quan -->
    <div class="related-products mt-5" th:if="${!relatedProducts.empty}">
        <h3 class="section-title" th:text="#{spct.RelatedProducts}"></h3>
        <div class="row">
            <div class="col-md-3 mb-4" th:each="relatedProduct : ${relatedProducts}">
                <div class="card product-card h-100">
                    <a th:href="@{/san-pham/chi-tiet/{id}(id=${relatedProduct.id ?: 0})}" class="text-decoration-none">
                        <img th:if="${relatedProduct.idHinhAnhDaiDien != null}"
                             th:src="${relatedProduct.idHinhAnhDaiDien.duongDan}"
                             class="card-img-top"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';"
                             th:alt="${relatedProduct.tenSanPham}">
                        <img th:unless="${relatedProduct.idHinhAnhDaiDien != null}"
                             src="/images/no-image.jpg"
                             class="card-img-top"
                             alt="No image available">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${relatedProduct.tenSanPham}">Tên sản phẩm liên quan</h5>
                    <div class="card-text product-price">
                      <span th:if="${relatedProduct.phanTramGiam != null and relatedProduct.phanTramGiam > 0}"
                          class="text-muted text-decoration-line-through me-2"
                          th:text="${#numbers.formatDecimal(relatedProduct.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
                      <span th:text="${(relatedProduct.phanTramGiam != null and relatedProduct.phanTramGiam > 0) ?
                                  #numbers.formatDecimal(relatedProduct.giaSauGiam, 0, 'COMMA', 0, 'POINT') + 'đ' :
                                  (relatedProduct.giaBan != null ? #numbers.formatDecimal(relatedProduct.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ')}">Giá</span>
                    </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Gợi ý theo sản phẩm đã xem -->
    <div class="related-products mt-5" th:if="${recommendedProducts != null and !#lists.isEmpty(recommendedProducts)}">
        <h3 class="section-title" th:text="#{spct.suggest}"></h3>
        <div class="row">
            <div class="col-md-3 mb-4" th:each="rp : ${recommendedProducts}">
                <div class="card product-card h-100">
                    <a th:href="@{/san-pham/chi-tiet/{id}(id=${rp.id ?: 0})}" class="text-decoration-none">
                        <img th:if="${rp.idHinhAnhDaiDien != null}"
                             th:src="${rp.idHinhAnhDaiDien.duongDan}"
                             class="card-img-top"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';"
                             th:alt="${rp.tenSanPham}">
                        <img th:unless="${rp.idHinhAnhDaiDien != null}"
                             src="/images/no-image.jpg"
                             class="card-img-top"
                             alt="No image available">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${rp.tenSanPham}">Tên sản phẩm gợi ý</h5>
                    <div class="card-text product-price">
                      <span th:if="${rp.phanTramGiam != null and rp.phanTramGiam > 0}"
                          class="text-muted text-decoration-line-through me-2"
                          th:text="${#numbers.formatDecimal(rp.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
                      <span th:text="${(rp.phanTramGiam != null and rp.phanTramGiam > 0) ?
                                  #numbers.formatDecimal(rp.giaSauGiam, 0, 'COMMA', 0, 'POINT') + 'đ' :
                                  (rp.giaBan != null ? #numbers.formatDecimal(rp.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ')}">Giá</span>
                    </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include JavaScript file -->
<th:block layout:fragment="extra-js">
    <script src="/js/chi-tiet-san-pham.js"></script>
    <script th:inline="javascript">
        // Pass all necessary data to JavaScript
        window.productId = /*[[${product.id}]]*/ null;
        window.tonKhoMap = /*[[${tonKhoMap}]]*/ {};
        window.variants = /*[[${variants}]]*/ [];
        window.availableSizes = /*[[${kichCos}]]*/ [];
        window.availableColors = /*[[${mauSacs}]]*/ [];

        // Set stock data from server (legacy function call)
        window.setStockData(/*[[${tonKhoMap}]]*/ {});
        // Optional: enable debug logs in dev only by setting window.ENV_DEBUG = true in the console
        if (window.ENV_DEBUG) {
            console.log('Backend data received:', {
                tonKhoMap: window.tonKhoMap,
                variants: window.variants,
                availableSizes: window.availableSizes,
                availableColors: window.availableColors
            });
        }
    </script>
</th:block>
    <script th:inline="javascript">
        // Ẩn counter nếu không còn ảnh hợp lệ
        window.updateImageCounter = function() {
            const counterElement = document.getElementById('currentImageIndex');
            const totalElement = document.getElementById('totalImageCount');
            const counterBlock = document.getElementById('imageCounterBlock');

            // Lấy index hiện tại từ JS gallery nếu có, fallback về 1
            let currentIndex = 1;
            if (window.galleryImages && Array.isArray(window.galleryImages) && window.galleryImages.length > 0 && typeof window.currentImageIndex === 'number') {
                currentIndex = window.currentImageIndex + 1;
            }

            const visibleThumbnails = Array.from(document.querySelectorAll('.thumbnail-item')).filter(thumb => {
                const img = thumb.querySelector('img');
                return img && img.style.display !== 'none';
            });

            if (counterBlock) {
                if (visibleThumbnails.length > 0) {
                    counterBlock.style.display = '';
                    if (counterElement) counterElement.textContent = currentIndex;
                    if (totalElement) totalElement.textContent = visibleThumbnails.length;
                } else {
                    counterBlock.style.display = 'none';
                }
            }
        }

        /* Đa ngôn ngữ */
        const TEXT_CHOOSE_SIZE        = [[#{spct.choose.size}]];
        const TEXT_CHOOSE_SIZE_COLOR  = [[#{spct.choose.size.color}]];
        const TEXT_ADD_TO_CART        = [[#{spct.add.to.cart}]];
        const TEXT_BUY_NOW            = [[#{spct.buy.now}]];
        const TEXT_OUT_OF_STOCK       = [[#{spct.out.of.stock}]];
    </script>


</div>

</html>