<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>

    <title layout:fragment="title"
           th:text="${product != null ? product.tenSanPham : 'Chi tiết sản phẩm'} + ' - UrbanSteps'">Chi tiết sản phẩm -
        UrbanSteps</title>
    <meta charset="UTF-8">
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" href="/css/chi-tiet-san-pham.css">
    </th:block>

    <style>
        /* --- TỔNG QUAN KHU VỰC ĐÁNH GIÁ --- */
        .product-reviews {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #333;
            border: 1px solid #e0e0e0;
            padding: 2rem;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .product-reviews h5 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.75rem;
        }

        /* --- TÓM TẮT RATING --- */
        #product-rating-summary {
            font-size: 1.2rem;
            color: #666;
        }
        #product-rating-summary .average-rating {
            font-weight: bold;
            font-size: 1.8rem;
            color: #000;
        }
        #product-rating-summary .average-rating::after {
            content: " ★";
            color: #ffc107;
            font-size: 1.5rem;
            vertical-align: middle;
        }

        /* --- FORM GỬI ĐÁNH GIÁ --- */
        .review-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background-color: #f9f9f9;
        }

        .review-box .review-stars {
            font-size: 1.8rem;
            color: #ccc;
            margin-bottom: 1rem;
        }

        .review-box .review-stars .star:hover {
            color: #ffc107;
        }

        .review-box textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 0.5rem;
        }

        .review-box .review-submit-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            border: none;
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .review-box .review-submit-btn:hover {
            background-color: #0056b3;
        }

        /* --- DANH SÁCH CÁC ĐÁNH GIÁ --- */
        .review-list .review-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .review-list .review-item:last-child {
            border-bottom: none;
        }

        .review-item .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .review-item .meta {
            flex-grow: 1;
        }

        .review-item .name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .review-item .time {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .review-item .review-stars {
            color: #ffc107; / Màu vàng cho các sao đã chọn */
        margin-bottom: 0.75rem;
        }

        .review-item .review-star {
            font-size: 1rem;
        }

        /* CSS cho sao chưa được tô màu (nếu cần thiết, ví dụ khi hiển thị đánh giá trung bình) /
        / Nếu bạn muốn hiển thị các sao "rỗng" khi không phải là số sao đánh giá của người dùng, bạn có thể thêm: /

         */
        .review-item .review-star:not(.filled) {
        color: #e0e0e0;
        }

        /* Trong trường hợp này, vì bạn muốn tất cả các sao đều "đầy" theo số điểm đánh giá,
        chúng ta sẽ đảm bảo rằng class 'filled' được thêm đúng cách trong Thymeleaf. */


        .review-item p {
            margin: 0;
            line-height: 1.6;
            color: #555;
        }

        /* --- YÊU CẦU ĐĂNG NHẬP --- */
        #review-form-area div > p {
            padding: 1rem;
            background-color: #e9f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 5px;
        }
    </style>

</head>

<div layout:fragment="content">
    <div class="container mt-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb custom-breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/}">
                        <i class="bi bi-house-door"></i>
                        <span th:text="#{home.title}"></span>
                    </a>
                </li>

                <li class="breadcrumb-separator">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M6.646 1.646a.5.5 0 0 1 .708 0l4.5 4.5a.5.5 0 0 1 0 .708l-4.5 4.5a.5.5 0 0 1-.708-.708L10.293 6 6.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/san-pham}" th:text="#{spct.detail.namelink}"></a>
                </li>
                <li class="breadcrumb-separator">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M6.646 1.646a.5.5 0 0 1 .708 0l4.5 4.5a.5.5 0 0 1 0 .708l-4.5 4.5a.5.5 0 0 1-.708-.708L10.293 6 6.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${product.tenSanPham}">Chi tiết sản phẩm</li>
            </ol>
            <style>
                .custom-breadcrumb {
                    background: none;
                    padding: 0;
                    margin-bottom: 1rem;
                    font-size: 1.1rem;
                }
                .custom-breadcrumb .breadcrumb-item a {
                    color: #1976d2;
                    text-decoration: underline;
                    font-weight: 500;
                    transition: color 0.2s;
                }
                .custom-breadcrumb .breadcrumb-item a:hover {
                    color: #ff6600;
                    text-decoration: underline;
                }
                .custom-breadcrumb .breadcrumb-separator {
                    display: inline-block;
                    vertical-align: middle;
                    margin: 0 0.3rem;
                }
                .custom-breadcrumb .breadcrumb-item.active {
                    color: #333;
                    font-weight: 600;
                }
            </style>
        </nav>

        <div class="row">
            <!-- Hình ảnh sản phẩm -->
            <div class="col-md-6">
                <div class="product-gallery-container">
                    <!-- Gallery layout: vertical thumbnails + main image -->
                    <div class="gallery-layout" th:if="${productImages != null and !#lists.isEmpty(productImages)}">

                        <!-- Thumbnail column (vertical) -->
                        <div class="thumbnails-column" th:if="${productImages.size() > 1}">
                            <div class="thumbnails-wrapper">
                                <div class="thumbnail-scroll-container" id="thumbnailScrollContainer">
                                    <div th:each="img, imgStat : ${productImages}"
                                         th:class="${imgStat.index == 0 ? 'thumbnail-item active' : 'thumbnail-item'}"
                                         th:data-image="${img.duongDan}"
                                         th:data-index="${imgStat.index}"
                                         onclick="changeMainImage(this)">
                                        <div class="thumbnail-frame">
                                            <img th:src="${img.duongDan}"
                                                 th:alt="${product.tenSanPham + ' - Ảnh ' + (imgStat.count)}"
                                                 class="thumbnail-img"
                                                 onerror="this.style.display='none'; this.parentElement.parentElement.style.display='none'; if(window.updateImageCounter) window.updateImageCounter();">
                                            <div class="thumbnail-overlay">
                                                <div class="thumbnail-number" th:text="${imgStat.count}">1</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Scroll navigation for thumbnails -->
                                <div class="thumbnail-nav" th:if="${productImages.size() > 5}">
                                    <button class="thumb-nav-btn thumb-nav-up" id="thumbNavUp" onclick="scrollThumbnails('up')">
                                        <i class="bi bi-chevron-up"></i>
                                    </button>
                                    <button class="thumb-nav-btn thumb-nav-down" id="thumbNavDown" onclick="scrollThumbnails('down')">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Main image area -->
                        <div class="main-image-area">
                            <div class="main-image-container">
                                <!-- Image loading overlay -->
                                <div class="image-loading-overlay" id="imageLoadingOverlay">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Main product image -->
                                <img id="main-product-image"
                                     th:src="${productImages[0].duongDan}"
                                     th:alt="${product.tenSanPham}"
                                     class="main-product-image"
                                     onerror="this.onerror=null; this.src='/images/no-image.jpg';">

                                <!-- Zoom indicator -->
                                <div class="zoom-indicator">
                                    <i class="bi bi-zoom-in"></i>
                                    <span>Click để phóng to</span>
                                </div>

                                <!-- Navigation dots for mobile -->
                                <div class="image-dots d-md-none" th:if="${productImages.size() > 1}">
                                    <span th:each="img, imgStat : ${productImages}"
                                          th:class="${imgStat.index == 0 ? 'dot active' : 'dot'}"
                                          th:data-index="${imgStat.index}"
                                          onclick="changeMainImage(document.querySelector('[data-index=\'' + this.dataset.index + '\']'))"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fallback for single image or no images -->
                    <div class="single-image-container" th:if="${productImages == null or #lists.isEmpty(productImages) or productImages.size() == 1}">
                        <img id="main-product-image-single"
                             th:if="${productImages != null and !#lists.isEmpty(productImages)}"
                             th:src="${productImages[0].duongDan}"
                             th:alt="${product.tenSanPham}"
                             class="main-product-image"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';">
                        <img th:unless="${productImages != null and !#lists.isEmpty(productImages)}"
                             id="main-product-image-single"
                             th:src="${product.idHinhAnhDaiDien != null ? product.idHinhAnhDaiDien.duongDan : '/images/no-image.jpg'}"
                             th:alt="${product.tenSanPham}"
                             class="main-product-image"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';">
                    </div>
                </div>

                <!-- Image info -->
                <div class="image-info mt-3" th:if="${productImages != null and !#lists.isEmpty(productImages)}">
                    <div class="image-counter" id="imageCounterBlock">
                        <span id="currentImageIndex">1</span> / <span th:text="${productImages.size()}" id="totalImageCount">[[${productImages.size()}]]</span>
                    </div>
                    <div class="image-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openLightbox()" th:if="${productImages.size() > 1}">
                            <i class="bi bi-arrows-fullscreen"></i>
                            <span th:text="#{spct.zoom}"></span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1" onclick="shareImage()">
                            <i class="bi bi-share"></i>
                            <span th:text="#{spct.share}"></span>
                        </button>

                    </div>
                </div>
            </div>

            <!-- Thông tin sản phẩm -->
            <div class="col-md-6">
                <h1 class="product-title" th:text="${product.tenSanPham}">Tên sản phẩm</h1>

                <style>
                    /* Make brand more prominent when displayed under product code */
                    .product-info .info-value {
                        font-size: 1.05rem;
                        font-weight: 600;
                        color: #2c3e50;
                        margin-left: 6px;
                    }
                    /* Ensure review list area stands out */
                    #review-list p { margin: 0.25rem 0; }
                    .review-stars .review-star { color: #ccc; font-size:1.1rem; margin-right:4px; }
                    .review-stars .review-star.filled, #star-rating .star.filled { color: #f5b301; }
                    #star-rating .star { color: #ccc; font-size:22px; margin-right:6px; }
                </style>

            <div class="product-meta d-flex align-items-center mb-3">
                <div class="product-code d-flex align-items-center me-4">
                    <span class="me-2 text-muted" th:text="#{spct.detail.code}">Mã Sản Phẩm:</span>
                    <span th:text="${product.maSanPham}" class="code">SP001</span>
                </div>
                <div class="product-brand" th:if="${product.thuongHieu != null}">
                    <span class="info-label text-muted me-2" th:text="#{spct.brand}">Thương hiệu</span>
                    <span class="info-value" th:text="${product.thuongHieu.tenThuongHieu}">Nike</span>
                </div>
            </div>

        <div class="product-price mb-4">
            <div class="mb-2">
              <span th:if="${product.phanTramGiam != null and product.phanTramGiam > 0}"
                  class="badge rounded-pill bg-danger me-1">SALE -<span th:text="${#numbers.formatDecimal(product.phanTramGiam,0,0)}"></span>%</span>
              <span th:if="${product.luotBan != null and product.luotBan > 0}"
                  class="badge rounded-pill bg-warning text-dark">HOT</span>
            </div>
            <span th:if="${product.phanTramGiam != null and product.phanTramGiam > 0}"
                class="text-muted text-decoration-line-through me-2"
                th:text="${#numbers.formatDecimal(product.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
            <span class="current-price"
                th:text="${(product.phanTramGiam != null and product.phanTramGiam > 0) ?
                         #numbers.formatDecimal(product.giaSauGiam, 0, 'COMMA', 0, 'POINT') + 'đ' :
                         (product.giaBan != null ? #numbers.formatDecimal(product.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ')}">1,200,000đ</span>
        </div>

            <!-- Chọn kích cỡ -->
            <div class="product-size mb-3" th:if="${!kichCos.empty}">
                <h5 th:text="#{spct.size}"></h5>
                <div class="size-options">
                    <div th:each="size : ${kichCos}" class="size-option">
                        <input type="radio" th:id="${'size-' + size}" name="size" th:value="${size}">
                        <label th:for="${'size-' + size}" th:text="${size}">40</label>
                    </div>
                </div>
            </div>

            <!-- Chọn màu sắc -->
            <div class="product-color mb-3" th:if="${!mauSacs.empty}">
                <h5 th:text="#{spct.color}"></h5>
                <div class="color-options">
                    <div th:each="color : ${mauSacs}" class="color-option">
                        <input type="radio" th:id="${'color-' + color}" name="color" th:value="${color}">
                        <label th:for="${'color-' + color}" th:text="${color}">Đen</label>
                    </div>
                </div>
            </div>

            <!-- Hidden input for single color -->
            <!-- Hidden input for single color (giữ lại nếu muốn auto-check) -->
            <!-- Nếu muốn cho phép chọn, có thể bỏ đoạn này hoặc để auto-check khi chỉ có 1 màu -->

            <!-- Số lượng tồn kho -->
            <div class="product-stock mb-3" th:if="${!kichCos.empty && !mauSacs.empty}">
                <span th:text="#{spct.remainingproducts}"> </span>
                <span id="stock-quantity"
                      th:text="${mauSacs.size() == 1 ? 'Vui lòng chọn kích cỡ' : 'Vui lòng chọn kích cỡ và màu sắc'}">
                </span>
            </div>

            <!-- Số lượng mua -->
            <div class="product-quantity mb-3">
                <h5 class="quantity-label" th:text="#{spct.quantity}"></h5>
                <div class="quantity-selector">
                    <button id="decrease-quantity" class="quantity-btn decrease-btn" type="button">
                        <i class="bi bi-dash"></i>
                    </button>
                    <div class="quantity-display">
                        <input type="number" id="quantity" value="1" min="1" class="quantity-input" readonly>
                        <span class="quantity-label-text" th:text="#{spct.sanpham}"></span>
                    </div>
                    <button id="increase-quantity" class="quantity-btn increase-btn" type="button">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Nút thêm vào giỏ hàng -->
            <div class="product-actions mb-4">
                <button id="add-to-cart" class="btn btn-secondary add-to-cart-btn" disabled
                        th:text="${mauSacs.size() == 1 ? 'Chọn kích cỡ' : 'Chọn kích cỡ và màu'}">
                    <i class="bi bi-cart-plus"></i> Chọn kích cỡ và màu
                </button>
                <button id="buy-now" class="btn btn-secondary buy-now-btn" disabled
                        th:text="${mauSacs.size() == 1 ? 'Chọn kích cỡ' : 'Chọn kích cỡ và màu'}">
                    <i class="bi bi-lightning-fill"></i> Chọn kích cỡ và màu
                </button>
            </div>

            <!-- External marketplace buy buttons -->
            <div class="external-buy mb-4" th:if="${product.shopeeUrl != null or product.lazadaUrl != null or product.facebookShopUrl != null}">
                <h5>Mua trên sàn</h5>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <a th:if="${product.shopeeUrl != null}" th:href="${product.shopeeUrl}" target="_blank" class="btn btn-warning">Mua trên Shopee</a>
                    <a th:if="${product.lazadaUrl != null}" th:href="${product.lazadaUrl}" target="_blank" class="btn btn-primary" style="background-color:#1a73e8;">Mua trên Lazada</a>
                    <a th:if="${product.facebookShopUrl != null}" th:href="${product.facebookShopUrl}" target="_blank" class="btn btn-secondary">Facebook Shop</a>
                </div>
            </div>

            <!-- Mô tả sản phẩm -->
            <div class="product-description mb-4" th:if="${product.moTa != null && !product.moTa.empty}">
                <h5 th:text="#{spct.description}"></h5>
                <p th:text="${product.moTa}">Mô tả sản phẩm sẽ hiển thị ở đây...</p>
            </div>

            <!-- Đánh giá sản phẩm -->
            <div id="review-section" class="product-reviews mb-5" th:attr="data-product-id=${product.id}">
                <h5 th:text="#{product.detail.reviews}">Đánh giá sản phẩm</h5>
                <div id="product-rating-summary" class="mb-2 d-flex align-items-center gap-2">
                    <span th:if="${product.diemDanhGia != null}" class="average-rating" th:text="${product.diemDanhGia}">0</span>
                    <span th:if="${product.soLuongDanhGia != null}" class="review-count" th:text="'(' + ${product.soLuongDanhGia} + ' đánh giá)'"></span>
                </div>
                <div id="review-message"></div>
                <div id="review-form-area" class="mt-3">
                    <form id="review-form" th:if="${#authentication.name != 'anonymousUser'}" class="review-box">
                        <div class="box-header">
                            <div id="star-rating" class="review-stars" style="cursor:pointer; user-select:none;">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" name="diemDanhGia" value="5">
                        </div>
                        <textarea name="noiDung" placeholder="Viết bình luận của bạn..." required></textarea>
                        <button type="submit" class="review-submit-btn" title="Gửi đánh giá">➤</button>
                    </form>
                    <div th:unless="${#authentication.name != 'anonymousUser'}">
                        <p><a th:href="@{/dang-nhap(redirectUrl='/san-pham/chi-tiet/' + ${product.id})}">Đăng nhập</a> để gửi đánh giá.</p>
                    </div>
                </div>
                <div id="review-list" class="mt-4">
                    <div th:each="review : ${product.danhGia}" class="review-item">
                            <div class="avatar" th:text="${review.taiKhoan != null ? (review.taiKhoan.hoTenTaiKhoan != null ? #strings.substring(review.taiKhoan.hoTenTaiKhoan, 0,1) : (review.taiKhoan.taiKhoan != null ? #strings.substring(review.taiKhoan.taiKhoan,0,1) : 'A')) : 'A'}">A</div>
                        <div class="meta">
                            <div class="name" th:text="${review.taiKhoan != null ? (review.taiKhoan.hoTenTaiKhoan != null ? review.taiKhoan.hoTenTaiKhoan : review.taiKhoan.taiKhoan) : 'Ẩn danh'}">Tên người dùng</div>
                            <div class="time" th:text="${review.createAt != null ? #temporals.format(review.createAt, 'dd/MM/yyyy') : ''}">01/01/2025</div>
                            <div class="review-stars">
                                <span th:each="star : ${#numbers.sequence(1, 5)}" class="review-star"
                                      th:classappend="${star <= review.diemDanhGia} ? ' filled' : ''">☆</span>
                            </div>
                            <p th:text="${review.noiDung}">Nội dung đánh giá</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- duplicate brand block removed -->
        </div>
    </div>

    <!-- Sản phẩm liên quan -->
    <div class="related-products mt-5" th:if="${!relatedProducts.empty}">
        <h3 class="section-title" th:text="#{spct.RelatedProducts}"></h3>
        <div class="row">
            <div class="col-md-3 mb-4" th:each="relatedProduct : ${relatedProducts}">
                <div class="card product-card h-100">
                    <a th:href="@{/san-pham/chi-tiet/{id}(id=${relatedProduct.id ?: 0})}" class="text-decoration-none">
                        <img th:if="${relatedProduct.idHinhAnhDaiDien != null}"
                             th:src="${relatedProduct.idHinhAnhDaiDien.duongDan}"
                             class="card-img-top"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';"
                             th:alt="${relatedProduct.tenSanPham}">
                        <img th:unless="${relatedProduct.idHinhAnhDaiDien != null}"
                             src="/images/no-image.jpg"
                             class="card-img-top"
                             alt="No image available">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${relatedProduct.tenSanPham}">Tên sản phẩm liên quan</h5>
                    <div class="card-text product-price">
                      <span th:if="${relatedProduct.phanTramGiam != null and relatedProduct.phanTramGiam > 0}"
                          class="text-muted text-decoration-line-through me-2"
                          th:text="${#numbers.formatDecimal(relatedProduct.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
                      <span th:text="${(relatedProduct.phanTramGiam != null and relatedProduct.phanTramGiam > 0) ?
                                  #numbers.formatDecimal(relatedProduct.giaSauGiam, 0, 'COMMA', 0, 'POINT') + 'đ' :
                                  (relatedProduct.giaBan != null ? #numbers.formatDecimal(relatedProduct.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ')}">Giá</span>
                    </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Gợi ý theo sản phẩm đã xem -->
    <div class="related-products mt-5" th:if="${recommendedProducts != null and !#lists.isEmpty(recommendedProducts)}">
        <h3 class="section-title" th:text="#{spct.suggest}"></h3>
        <div class="row">
            <div class="col-md-3 mb-4" th:each="rp : ${recommendedProducts}">
                <div class="card product-card h-100">
                    <a th:href="@{/san-pham/chi-tiet/{id}(id=${rp.id ?: 0})}" class="text-decoration-none">
                        <img th:if="${rp.idHinhAnhDaiDien != null}"
                             th:src="${rp.idHinhAnhDaiDien.duongDan}"
                             class="card-img-top"
                             onerror="this.onerror=null; this.src='/images/no-image.jpg';"
                             th:alt="${rp.tenSanPham}">
                        <img th:unless="${rp.idHinhAnhDaiDien != null}"
                             src="/images/no-image.jpg"
                             class="card-img-top"
                             alt="No image available">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${rp.tenSanPham}">Tên sản phẩm gợi ý</h5>
                    <div class="card-text product-price">
                      <span th:if="${rp.phanTramGiam != null and rp.phanTramGiam > 0}"
                          class="text-muted text-decoration-line-through me-2"
                          th:text="${#numbers.formatDecimal(rp.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
                      <span th:text="${(rp.phanTramGiam != null and rp.phanTramGiam > 0) ?
                                  #numbers.formatDecimal(rp.giaSauGiam, 0, 'COMMA', 0, 'POINT') + 'đ' :
                                  (rp.giaBan != null ? #numbers.formatDecimal(rp.giaBan, 0, 'COMMA', 0, 'POINT') + 'đ' : 'Liên hệ')}">Giá</span>
                    </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include JavaScript file -->
<th:block layout:fragment="extra-js">
    <script src="/js/chi-tiet-san-pham.js"></script>
    <script src="/js/product-review.js"></script>
    <script th:inline="javascript">
        // Pass all necessary data to JavaScript
        window.productId = /*[[${product.id}]]*/ null;
        window.tonKhoMap = /*[[${tonKhoMap}]]*/ {};
        window.variants = /*[[${variants}]]*/ [];
        window.availableSizes = /*[[${kichCos}]]*/ [];
        window.availableColors = /*[[${mauSacs}]]*/ [];

        // Set stock data from server (legacy function call)
        window.setStockData(/*[[${tonKhoMap}]]*/ {});
        // Optional: enable debug logs in dev only by setting window.ENV_DEBUG = true in the console
        if (window.ENV_DEBUG) {
            console.log('Backend data received:', {
                tonKhoMap: window.tonKhoMap,
                variants: window.variants,
                availableSizes: window.availableSizes,
                availableColors: window.availableColors
            });
        }
    </script>
</th:block>
    <script th:inline="javascript">
        // Ẩn counter nếu không còn ảnh hợp lệ
        window.updateImageCounter = function() {
            const counterElement = document.getElementById('currentImageIndex');
            const totalElement = document.getElementById('totalImageCount');
            const counterBlock = document.getElementById('imageCounterBlock');

            // Lấy index hiện tại từ JS gallery nếu có, fallback về 1
            let currentIndex = 1;
            if (window.galleryImages && Array.isArray(window.galleryImages) && window.galleryImages.length > 0 && typeof window.currentImageIndex === 'number') {
                currentIndex = window.currentImageIndex + 1;
            }

            const visibleThumbnails = Array.from(document.querySelectorAll('.thumbnail-item')).filter(thumb => {
                const img = thumb.querySelector('img');
                return img && img.style.display !== 'none';
            });

            if (counterBlock) {
                if (visibleThumbnails.length > 0) {
                    counterBlock.style.display = '';
                    if (counterElement) counterElement.textContent = currentIndex;
                    if (totalElement) totalElement.textContent = visibleThumbnails.length;
                } else {
                    counterBlock.style.display = 'none';
                }
            }
        }

    /* Đa ngôn ngữ */
    const TEXT_CHOOSE_SIZE        = /*[[#{spct.choose.size}]]*/ 'Chọn kích cỡ';
    const TEXT_CHOOSE_SIZE_COLOR  = /*[[#{spct.choose.size.color}]]*/ 'Chọn kích cỡ và màu';
    const TEXT_ADD_TO_CART        = /*[[#{spct.add.to.cart}]]*/ 'Thêm vào giỏ';
    const TEXT_BUY_NOW            = /*[[#{spct.buy.now}]]*/ 'Mua ngay';
    const TEXT_OUT_OF_STOCK       = /*[[#{spct.out.of.stock}]]*/ 'Hết hàng';
    </script>


</div>

</html>