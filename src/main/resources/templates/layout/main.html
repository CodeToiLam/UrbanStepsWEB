<!DOCTYPE html>
<html th:lang="${#locale}" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title layout:title-pattern="$CONTENT_TITLE - UrbanSteps">UrbanSteps</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <link rel="stylesheet" type="text/css" href="/css/main.css">
  <!-- Consolidated header/footer styles with version for cache busting -->
  <link rel="stylesheet" th:href="@{'/css/layout-main.css?v=20250809a'}">
  <link rel="stylesheet" th:href="@{'/css/footer.css?v=20250809a'}">
  <link rel="stylesheet" th:href="@{'/css/account.css?v=20250811'}">
  <link rel="stylesheet" th:href="@{'/css/order.css?v=20250811'}">

</head>
<body>

<div class="header-top">[[#{header.notice}]]</div>

<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <a href="/" class="brand" aria-label="UrbanSteps home">
        <img src="/images/Home/logo.jpg" alt="UrbanSteps" class="brand-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex'">
        <span class="brand-fallback">Urban<span>Steps</span></span>
      </a>
  <nav class="primary-nav" aria-label="Danh mục chính">
        <a href="/san-pham?thuongHieu=MLB">MLB</a>
        <a href="/san-pham?thuongHieu=Adidas">Adidas</a>
        <a href="/san-pham?thuongHieu=Converse">Converse</a>
        <a href="/san-pham?sale=true" class="nav-label sale" aria-label="[[#{nav.products}]]">SALE</a>
        <a href="/san-pham?hot=true" class="nav-label hot" aria-label="[[#{nav.products}]]">HOT</a>
      </nav>
    </div>
    <div class="header-right">
      <div class="lang-switch dropdown me-2" th:with="cur=${#locale}">
        <button class="icon-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" th:title="#{nav.language}">
          <img class="flag-img" th:src="${cur.language}=='en' ? @{/images/en.jpg} : @{/images/vn.jpg}" alt="lang" width="20" height="14"/>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item d-flex align-items-center gap-2" th:href="@{?(lang='vi')}" th:classappend="${cur.language}=='vi' ? ' active' : ''" aria-current="true" data-lang="vi">
              <img class="flag-img" src="/images/vn.jpg" alt="VI" width="20" height="14"/>
              <span>[[#{lang.vi}]]</span>
            </a>
          </li>
          <li>
            <a class="dropdown-item d-flex align-items-center gap-2" th:href="@{?(lang='en')}" th:classappend="${cur.language}=='en' ? ' active' : ''" aria-current="true" data-lang="en">
              <img class="flag-img" src="/images/en.jpg" alt="EN" width="20" height="14"/>
              <span>[[#{lang.en}]]</span>
            </a>
          </li>
        </ul>
      </div>
    <div class="search-wrapper" data-search>
        <form action="/tim-kiem" method="get" class="header-search-form" role="search">
      <input type="text" name="q" class="header-search-input" th:placeholder="#{search.placeholder}" placeholder="Tìm kiếm giày..." aria-label="Tìm kiếm" />
          <button type="submit" class="icon-btn header-search-btn" aria-label="Tìm kiếm"><i class="bi bi-search"></i></button>
          <button type="button" class="icon-btn header-close-search" aria-label="Đóng tìm kiếm"><i class="bi bi-x"></i></button>
        </form>
        <button type="button" class="icon-btn header-trigger-search" aria-label="Mở tìm kiếm"><i class="bi bi-search"></i></button>
      </div>
      <a href="/gio-hang" class="icon-btn cart-icon" title="Giỏ hàng" aria-label="Giỏ hàng">
        <i class="bi bi-cart"></i>
        <span class="cart-count" th:text="${gioHang != null ? gioHang.items.size() : 0}">0</span>
      </a>
      <div class="account-cluster" th:if="${#authentication.name != 'anonymousUser'}">
        <a href="/don-hang" class="icon-btn" title="Đơn hàng" aria-label="Đơn hàng"><i class="bi bi-box-seam"></i></a>
        <a href="/tai-khoan" class="icon-btn" title="Tài khoản" aria-label="Tài khoản"><i class="bi bi-person"></i></a>
        <span sec:authorize="hasRole('ADMIN')">
          <a href="/admin" class="icon-btn" title="Quản trị" aria-label="Quản trị"><i class="bi bi-speedometer2"></i></a>
        </span>
        <form th:action="@{/dang-xuat}" method="post" class="logout-form">
          <button type="submit" class="icon-btn logout-btn" title="Đăng xuất" aria-label="Đăng xuất"><i class="bi bi-box-arrow-right"></i></button>
        </form>
      </div>
      <div class="account-cluster" th:if="${#authentication.name == 'anonymousUser'}">
        <a href="/don-hang" class="icon-btn" title="Tra cứu đơn hàng" aria-label="Tra cứu đơn hàng"><i class="bi bi-box-seam"></i></a>
        <a href="/dang-nhap" th:href="@{/dang-nhap}" class="icon-btn" title="Đăng nhập" aria-label="Đăng nhập"><i class="bi bi-person"></i></a>
      </div>
    </div>
  </div>
</header>

<main class="main-content" layout:fragment="content">
</main>

<div class="footer">
  <div class="footer-content">
    <div class="footer-section">
  <h3>[[#{footer.featuredBrands}]]</h3>
      <ul>
        <li><a href="/san-pham?thuongHieu=UrbanSteps">UrbanSteps</a></li>
        <li><a href="/san-pham?thuongHieu=Nike">[[#{footer.brand.nike}]]</a></li>
        <li><a href="/san-pham?thuongHieu=Adidas">[[#{footer.brand.adidas}]]</a></li>
        <li><a href="/san-pham?thuongHieu=Converse">[[#{footer.brand.converse}]]</a></li>
        <li><a href="/san-pham?thuongHieu=Peak">[[#{footer.brand.peak}]]</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>[[#{footer.customerSupport}]]</h3>
      <ul>
        <li><a href="/ho-tro">[[#{footer.faq}]]</a></li>
        <li><a href="/van-don">[[#{footer.shipping}]]</a></li>
        <li><a href="/huong-dan-tra-gop">[[#{footer.installmentGuide}]]</a></li>
        <li><a href="/huong-dan-doi-tra">[[#{footer.returnGuide}]]</a></li>
        <li><a href="/chinh-sach-doi-tra">[[#{footer.returnPolicy}]]</a></li>
        <li><a href="/chinh-sach-bao-hanh">[[#{footer.warrantyPolicy}]]</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>[[#{footer.about}]]</h3>
      <ul>
        <li><a href="/gioi-thieu">[[#{footer.aboutUs}]]</a></li>
        <li><a href="/cau-hoi-thuong-gap">[[#{footer.faqPage}]]</a></li>
        <li><a href="/tuyen-dung">[[#{footer.careers}]]</a></li>
        <li><a href="/dang-ky-ban-hang">[[#{footer.sellerRegister}]]</a></li>
        <li><a href="/lien-he">[[#{footer.contact}]]</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>[[#{footer.contactTitle}]]</h3>
      <ul>
        <li><a href="tel:+84287306552">[[#{footer.hotline1}]]</a></li>
        <li><a href="tel:+84947104105">[[#{footer.hotline2}]]</a></li>
        <li><a href="mailto:cskh@urbanshoes.vn">[[#{footer.email}]]</a></li>
        <li>[[#{footer.location}]]</li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <p>[[#{footer.copyNotice}]]</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="/js/banner-carousel.js"></script>

<script>
  // Header interactions: shrink on scroll & search toggle
  (function(){
    const onScroll=()=>{ if(window.scrollY>10){document.body.classList.add('scrolled')} else {document.body.classList.remove('scrolled')} };window.addEventListener('scroll',onScroll);onScroll();
    const wrapper=document.querySelector('[data-search]');
    if(wrapper){
      const trigger=wrapper.querySelector('.header-trigger-search');
      const closeBtn=wrapper.querySelector('.header-close-search');
      trigger && trigger.addEventListener('click',()=>wrapper.classList.add('active'));
      closeBtn && closeBtn.addEventListener('click',()=>wrapper.classList.remove('active'));
    }
  })();
  </script>

  <script>
  // Ensure the header flag matches the persisted cookie locale, even on pages not using this layout
    (function(){
      try{
        const cookie = document.cookie.split('; ').find(x=>x.startsWith('LANG='));
        if (!cookie) return;
    const lang = decodeURIComponent(cookie.split('=')[1]||'').split(';')[0];
    const isEn = (lang||'').toLowerCase().startsWith('en');
    const img = document.querySelector('.lang-switch .flag-img');
    if(img){ img.src = isEn ? '/images/en.jpg' : '/images/vn.jpg'; }
        // highlight active in menu if exists
        document.querySelectorAll('.lang-switch [data-lang]')
          .forEach(a=>{
            const active = a.getAttribute('data-lang') === (isEn? 'en':'vi');
            a.classList.toggle('active', active);
          });
      }catch(e){/*noop*/}
    })();
  </script>

<th:block layout:fragment="extra-js"></th:block>

<script>
  // Tự động load số lượng giỏ hàng khi trang load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    // Delay loading để tránh load liên tục
    setTimeout(() => {
      loadCartCount();
    }, 500);
  });

  let isLoadingCart = false;
  let lastLoadTime = 0;
  const LOAD_THROTTLE_MS = 2000; // Chỉ cho phép load mỗi 2 giây

  function loadCartCount() {
    const now = Date.now();

    // Kiểm tra throttle time
    if (now - lastLoadTime < LOAD_THROTTLE_MS) {
      console.log('Cart loading throttled, too soon since last load');
      return;
    }

    if (isLoadingCart) {
      console.log('Cart loading already in progress, skipping...');
      return;
    }

    isLoadingCart = true;
    lastLoadTime = now;

    fetch('/api/cart/info')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.success) {
                updateCartCount(data.itemCount);
              } else {
                console.warn('Cart info request failed:', data.message);
                updateCartCount(0); // Set fallback value
              }
            })
            .catch(error => {
              console.error('Error loading cart count:', error);
              // Set default value on error to prevent continuous loading
              updateCartCount(0);
            })
            .finally(() => {
              isLoadingCart = false;
            });
  }

  function updateCartCount(count) {
    const cartCountElement = document.querySelector('.cart-count');
    if (cartCountElement) {
      cartCountElement.textContent = count || 0;
      if (count > 0) {
        cartCountElement.style.display = 'flex';
      } else {
        cartCountElement.style.display = 'none';
      }
    }
  }

  // Expose function globally
  window.updateCartCount = updateCartCount;
</script>

</body>
</html>