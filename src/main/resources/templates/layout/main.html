<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title layout:title-pattern="$CONTENT_TITLE - UrbanSteps">UrbanSteps</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" type="text/css" href="/css/main.css">
  <link rel="stylesheet" type="text/css" href="/css/layout-main.css">

  <style>
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-image {
      height: 65px;
      width: auto;
      object-fit: contain;
    }

    .logo-text {
      font-size: 36px;
      font-weight: bold;
      color: #333;
      text-decoration: none;
    }

    .logo-link {
      display: flex;
      align-items: center;
      gap: 15px;
      text-decoration: none;
      color: inherit;
    }

    .logo-link:hover {
      text-decoration: none;
      color: inherit;
    }

    @media (max-width: 768px) {
      .logo-image {
        height: 50px;
      }

      .logo-text {
        font-size: 30px;
      }

      .logo {
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .logo-image {
        height: 40px;
      }

      .logo-text {
        font-size: 24px;
      }

      .logo {
        gap: 10px;
      }
    }
  </style>

</head>
<body>

<!-- Header -->
<div class="header-top">
  Mua giày, đến UrbanSteps.vn! - Giày chính hãng số 1 thế giới
</div>

<div class="header-main">
  <div class="header-content">
    <div class="logo">
      <a th:href="@{/}" class="logo-link">
        <img src="/images/Home/logo.jpg" alt="UrbanSteps Logo" class="logo-image">
        <span class="logo-text">UrbanSteps</span>
      </a>
    </div>
    <div class="nav-menu">
      <a href="/san-pham?thuongHieu=MLB" th:href="@{/san-pham(thuongHieu='MLB')}">MLB</a>
    <a href="/san-pham?thuongHieu=Adidas" th:href="@{/san-pham(thuongHieu='Adidas')}">Adidas</a>
    <a href="/san-pham?thuongHieu=Converse" th:href="@{/san-pham(thuongHieu='Converse')}">Converse</a>
    <a href="/san-pham?sale=true" th:href="@{/san-pham(sale=true)}" class="sale">SALE</a>
    <a href="/san-pham?hot=true" th:href="@{/san-pham(hot=true)}" class="hot">HOT</a>
    </div>
    <div class="icons">
      <a href="/tim-kiem" th:href="@{/tim-kiem}" class="icon-btn" title="Tìm kiếm">
        <i class="bi bi-search"></i>
      </a>
      <a href="/gio-hang" th:href="@{/gio-hang}" class="cart-icon" title="Giỏ hàng">
        <i class="bi bi-cart"></i>
        <span class="cart-count" th:text="${gioHang != null ? gioHang.items.size() : 0}">0</span>
      </a>
      
      <!-- User authentication section -->
      <div class="user-section" th:if="${#authentication.name != 'anonymousUser'}">
        <a href="/tai-khoan" class="icon-btn" title="Tài khoản">
          <i class="bi bi-person"></i>
        </a>
        <a href="/don-hang" class="icon-btn" title="Đơn hàng">
          <i class="bi bi-box-seam"></i>
        </a>
        <!-- Admin Panel link - only show for admin -->
        <span sec:authorize="hasRole('ADMIN')">
          <a href="/admin" class="icon-btn" title="Quản trị">
            <i class="bi bi-gear"></i>
          </a>
        </span>
        <form th:action="@{/dang-xuat}" method="post" style="display: inline;">
          <button type="submit" class="icon-btn logout-btn" title="Đăng xuất">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </form>
      </div>
      
      <!-- Login section for non-authenticated users -->
      <div class="login-section" th:if="${#authentication.name == 'anonymousUser'}">
        <a href="/don-hang" class="icon-btn" title="Tra cứu đơn hàng">
          <i class="bi bi-box-seam"></i>
        </a>
        <a href="/dang-nhap" th:href="@{/dang-nhap}" class="icon-btn" title="Đăng nhập">
          <i class="bi bi-person"></i>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<main class="main-content" layout:fragment="content">
  <!-- Page content will be inserted here -->
</main>

<!-- Footer -->
<div class="footer">
  <div class="footer-content">
    <div class="footer-section">
      <h3>Thương hiệu nổi bật</h3>
      <ul>
        <li><a href="#" th:href="@{/san-pham(thuongHieu='UrbanSteps')}">UrbanSteps</a></li>
        <li><a href="#" th:href="@{/san-pham(thuongHieu='Nike')}">Giày Nike</a></li>
        <li><a href="#" th:href="@{/san-pham(thuongHieu='Adidas')}">Giày Adidas</a></li>
        <li><a href="#" th:href="@{/san-pham(thuongHieu='Converse')}">Giày Converse</a></li>
        <li><a href="#" th:href="@{/san-pham(thuongHieu='Peak')}">Giày Peak</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>Hỗ trợ khách hàng</h3>
      <ul>
        <li><a href="#" th:href="@{/ho-tro}">FAQs & Help</a></li>
        <li><a href="#" th:href="@{/van-don}">Vận đơn</a></li>
        <li><a href="#" th:href="@{/huong-dan-tra-gop}">Hướng dẫn thanh toán trả góp</a></li>
        <li><a href="#" th:href="@{/huong-dan-doi-tra}">Hướng dẫn đổi trả</a></li>
        <li><a href="#" th:href="@{/chinh-sach-doi-tra}">Chính sách đổi trả</a></li>
        <li><a href="#" th:href="@{/chinh-sach-bao-hanh}">Chính sách bảo hành</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>Về UrbanSteps</h3>
      <ul>
        <li><a href="#" th:href="@{/gioi-thieu}">Giới thiệu UrbanSteps</a></li>
        <li><a href="#" th:href="@{/cau-hoi-thuong-gap}">Câu hỏi thường gặp</a></li>
        <li><a href="#" th:href="@{/tuyen-dung}">Tuyển dụng</a></li>
        <li><a href="#" th:href="@{/dang-ky-ban-hang}">Đăng ký bán hàng</a></li>
        <li><a href="#" th:href="@{/lien-he}">Liên hệ</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>Liên hệ</h3>
      <ul>
        <li><a href="tel:+84287306552">CS1: 028 7306 5552</a></li>
        <li><a href="tel:+84947104105">Giày: Hải (0947) 104-105</a></li>
        <li><a href="mailto:cskh@urbanshoes.vn">cskh@urbanshoes.vn</a></li>
        <li>Hà Nội, Việt Nam</li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <p>© 2025 UrbanSteps - Được bảo vệ bởi DMCA. Không sao chép nội dung mà không có sự cho phép!</p>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Common JS -->
<script src="/js/banner-carousel.js"></script>

<!-- Page specific JS -->
<th:block layout:fragment="extra-js"></th:block>

<script>
// Tự động load số lượng giỏ hàng khi trang load
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  // Delay loading để tránh load liên tục
  setTimeout(() => {
    loadCartCount();
  }, 500);
});

let isLoadingCart = false;
let lastLoadTime = 0;
const LOAD_THROTTLE_MS = 2000; // Chỉ cho phép load mỗi 2 giây

function loadCartCount() {
  const now = Date.now();
  
  // Kiểm tra throttle time
  if (now - lastLoadTime < LOAD_THROTTLE_MS) {
    console.log('Cart loading throttled, too soon since last load');
    return;
  }
  
  if (isLoadingCart) {
    console.log('Cart loading already in progress, skipping...');
    return;
  }
  
  isLoadingCart = true;
  lastLoadTime = now;
  
  fetch('/api/cart/info')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        updateCartCount(data.itemCount);
      } else {
        console.warn('Cart info request failed:', data.message);
        updateCartCount(0); // Set fallback value
      }
    })
    .catch(error => {
      console.error('Error loading cart count:', error);
      // Set default value on error to prevent continuous loading
      updateCartCount(0);
    })
    .finally(() => {
      isLoadingCart = false;
    });
}

function updateCartCount(count) {
  const cartCountElement = document.querySelector('.cart-count');
  if (cartCountElement) {
    cartCountElement.textContent = count || 0;
    if (count > 0) {
      cartCountElement.style.display = 'flex';
    } else {
      cartCountElement.style.display = 'none';
    }
  }
}

// Expose function globally
window.updateCartCount = updateCartCount;
</script>

</body>
</html>
