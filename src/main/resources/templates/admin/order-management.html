<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout-admin}">
<head>
    <title th:text="${title}"></title>
    <link rel="stylesheet" th:href="@{/css/order-management.css}">
    
</head>

<body>
<div layout:fragment="content">
    <div class="order-management">
        <h1>Quản lý đơn hàng</h1>

    <!-- Flash messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        
        <!-- Thẻ tóm tắt -->
        <div class="summary-cards">
            <div class="summary-card">
                <h3 th:text="${orders.totalElements}">0</h3>
                <p>Tổng đơn hàng</p>
            </div>
            <div class="summary-card">
                <h3 id="pendingCount">0</h3>
                <p>Chờ xử lý</p>
            </div>
            <div class="summary-card">
                <h3 id="completedCount">0</h3>
                <p>Hoàn thành</p>
            </div>
            <div class="summary-card">
                <h3 id="cancelledCount">0</h3>
                <p>Đã hủy</p>
            </div>
        </div>
        
        <!-- Thanh tìm kiếm và lọc -->
        <div class="search-filter-bar">
            <form th:action="@{/admin/order-management}" method="get">
                <div class="search-filter-row">
                    <div class="form-group">
                        <label for="search">Tìm kiếm</label>
                        <input type="text" id="search" name="search" 
                               th:value="${search}" 
                               placeholder="Mã đơn hàng, tên khách hàng, SĐT..."
                               class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Trạng thái</label>
                        <select id="status" name="status" class="form-control">
                            <option value="">Tất cả</option>
                            <option value="0" th:selected="${status != null && status == 0}">Chờ xử lý</option>
                            <option value="1" th:selected="${status != null && status == 1}">Đã xác nhận</option>
                            <option value="2" th:selected="${status != null && status == 2}">Đang giao</option>
                            <option value="3" th:selected="${status != null && status == 3}">Hoàn thành</option>
                            <option value="4" th:selected="${status != null && status == 4}">Đã hủy</option>
                            <option value="5" th:selected="${status != null && status == 5}">Đã thanh toán</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                    </div>
                    
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <a th:href="@{/admin/order-management}" class="btn btn-secondary">Xóa bộ lọc</a>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Bảng danh sách đơn hàng -->
        <div class="orders-table">
            <table class="table" th:if="${orders.hasContent()}">
                <thead>
                    <tr>
                        <th>Mã đơn hàng</th>
                        <th>Khách hàng</th>
                        <th>Số điện thoại</th>
                        <th>Phương thức</th>
                        <th class="col-address">Địa chỉ</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th class="col-actions">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order : ${orders.content}">
                        <td>
                            <strong th:text="${order.maHoaDon}">HD001</strong>
                        </td>
                        <td th:text="${order.khachHang.hoTenKhachHang}">Nguyễn Văn A</td>
                        <td th:text="${order.khachHang.sdt}">0123456789</td>
                        <td th:text="${order.phuongThucThanhToanText}">COD</td>
                        <td class="col-address"><span th:text="${order.diaChiGiaoHang} ?: '—'"></span></td>
                        <td>
                            <strong th:text="${#numbers.formatDecimal(order.tongThanhToan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">1,000,000 VNĐ</strong>
                        </td>
                        <td>
                            <span class="status-badge"
                                  th:classappend="${order.trangThai == 0} ? ' status-pending' :
                                                  (${order.trangThai == 1} ? ' status-confirmed' :
                                                  (${order.trangThai == 2} ? ' status-shipping' :
                                                  (${order.trangThai == 3} ? ' status-completed' :
                                                  (${order.trangThai == 4} ? ' status-cancelled' : ' status-paid'))))"
                                  th:text="${order.trangThaiText}">
                                Chờ xử lý
                            </span>
                        </td>
                        <td th:text="${#temporals.format(order.createAt, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</td>
                        <td class="col-actions">
                            <div class="action-buttons">
                                <a th:href="@{/admin/order-detail/{id}(id=${order.id})}" 
                                   class="btn btn-primary btn-sm">Chi tiết</a>
                                
                                                                <!-- Quick actions: one-click next status -->
                                                                <form th:if="${order.trangThai == 0}"
                                                                            th:action="@{/admin/order/update-status-form}" method="post" style="display:inline">
                                                                        <input type="hidden" name="orderId" th:value="${order.id}" />
                                                                        <input type="hidden" name="newStatus" value="1" />
                                                                        <input type="hidden" name="redirect" th:value="@{/admin/order-management(page=${currentPage},search=${search},status=${status})}" />
                                                                        <button type="submit" class="btn btn-success btn-sm">Đã xác nhận</button>
                                                                </form>
                                                                <form th:if="${order.trangThai == 1}"
                                                                            th:action="@{/admin/order/update-status-form}" method="post" style="display:inline">
                                                                        <input type="hidden" name="orderId" th:value="${order.id}" />
                                                                        <input type="hidden" name="newStatus" value="2" />
                                                                        <input type="hidden" name="redirect" th:value="@{/admin/order-management(page=${currentPage},search=${search},status=${status})}" />
                                                                        <button type="submit" class="btn btn-warning btn-sm">Đang giao</button>
                                                                </form>
                                                                <form th:if="${order.trangThai == 2}"
                                                                            th:action="@{/admin/order/update-status-form}" method="post" style="display:inline">
                                                                        <input type="hidden" name="orderId" th:value="${order.id}" />
                                                                        <input type="hidden" name="newStatus" value="3" />
                                                                        <input type="hidden" name="redirect" th:value="@{/admin/order-management(page=${currentPage},search=${search},status=${status})}" />
                                                                        <button type="submit" class="btn btn-success btn-sm">Hoàn thành</button>
                                                                </form>
                                                                <!-- Allow mark as Paid quickly when not final -->
                                                                <form th:if="${order.trangThai != 3 and order.trangThai != 4 and order.trangThai != 5}"
                                                                        th:action="@{/admin/order/update-status-form}" method="post" style="display:inline">
                                                                    <input type="hidden" name="orderId" th:value="${order.id}" />
                                                                    <input type="hidden" name="newStatus" value="5" />
                                                                    <input type="hidden" name="redirect" th:value="@{/admin/order-management(page=${currentPage},search=${search},status=${status})}" />
                                                                    <button type="submit" class="btn btn-success btn-sm">Đã thanh toán</button>
                                                                </form>
                                
                                <!-- Cập nhật trạng thái nhanh -->
                                <form th:action="@{/admin/order/update-status-form}" method="post" style="display:inline">
                                    <input type="hidden" name="orderId" th:value="${order.id}" />
                                    <input type="hidden" name="redirect" th:value="@{/admin/order-management(page=${currentPage},search=${search},status=${status})}" />
                                    <select name="newStatus" class="form-control status-select" style="width:auto;display:inline-block">
                                        <option th:value="0" th:selected="${order.trangThai==0}">Chờ xử lý</option>
                                        <option th:value="1" th:selected="${order.trangThai==1}">Đã xác nhận</option>
                                        <option th:value="2" th:selected="${order.trangThai==2}">Đang giao</option>
                                        <option th:value="3" th:selected="${order.trangThai==3}">Hoàn thành</option>
                                        <option th:value="4" th:selected="${order.trangThai==4}">Đã hủy</option>
                                        <option th:value="5" th:selected="${order.trangThai==5}">Đã thanh toán</option>
                                    </select>
                                    <button type="submit" class="btn btn-success btn-sm">Cập nhật</button>
                                </form>

                                <!-- Chỉ hiển thị nút hủy nếu có thể hủy -->
                                <form th:if="${order.canCancel()}" 
                                      th:action="@{/admin/order/cancel/{id}(id=${order.id})}" 
                                      method="post" style="display: inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" 
                                            onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')">
                                        Hủy
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="no-orders" th:unless="${orders.hasContent()}">
                <i class="fa fa-shopping-cart" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                <h3>Không có đơn hàng nào</h3>
                <p>Hiện tại chưa có đơn hàng nào phù hợp với tiêu chí tìm kiếm.</p>
            </div>
        </div>
        
        <!-- Phân trang -->
        <div class="pagination" th:if="${orders.totalPages > 1}">
            <a th:if="${currentPage > 0}"
               th:href="@{/admin/order-management(page=${currentPage-1}, search=${search}, status=${status})}">&laquo; Trước</a>

            <th:block th:each="page : ${#numbers.sequence(0, orders.totalPages-1)}">
                <a th:if="${page != currentPage}"
                   th:href="@{/admin/order-management(page=${page}, search=${search}, status=${status})}"
                   th:text="${page + 1}">1</a>
                <span th:if="${page == currentPage}"
                      class="active" th:text="${page + 1}">1</span>
            </th:block>

            <a th:if="${currentPage < orders.totalPages - 1}"
               th:href="@{/admin/order-management(page=${currentPage+1}, search=${search}, status=${status})}">Sau &raquo;</a>
        </div>
    </div>
</div>

<script th:src="@{/js/order-management.js}"></script>
</body>
</html>
