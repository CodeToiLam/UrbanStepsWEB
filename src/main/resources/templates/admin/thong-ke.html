<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout/layout-admin}">
<head>
    <title th:text="${title}">Dashboard - Thống kê</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard {
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .dashboard-title {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .date-range-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range-picker select,
        .date-range-picker input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .stat-card.revenue { border-left-color: #28a745; }
        .stat-card.orders { border-left-color: #007bff; }
        .stat-card.products { border-left-color: #ffc107; }
        .stat-card.customers { border-left-color: #17a2b8; }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            opacity: 0.1;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .stat-card.revenue::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%2328a745" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'); }
        .stat-card.orders::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23007bff" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>'); }
        .stat-card.products::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23ffc107" viewBox="0 0 24 24"><path d="M22 9h-4.79l-4.38-6.56c-.19-.28-.51-.42-.83-.42s-.64.14-.83.43L6.79 9H2c-.55 0-1 .45-1 1 0 .09.01.18.04.27l2.54 9.27c.23.84 1 1.46 1.92 1.46h13c.92 0 1.69-.62 1.93-1.46l2.54-9.27C23.99 10.18 24 10.09 24 10c0-.55-.45-1-1-1zM12 4.8L14.8 9H9.2L12 4.8zM18.5 19l-1.86-3.71c-.08-.15-.23-.29-.39-.29s-.31.14-.39.29L14 19h-4l-1.86-3.71c-.08-.15-.23-.29-.39-.29s-.31.14-.39.29L5.5 19H5l2-4h10l2 4h-.5z"/></svg>'); }
        .stat-card.customers::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%2317a2b8" viewBox="0 0 24 24"><path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63c-.34-1.02-1.31-1.74-2.46-1.74-1.15 0-2.12.72-2.46 1.74L12.5 16H15v6h5zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2.5 16v-7H6l-2.54-7.63C3.12 6.35 2.15 5.63 1 5.63S-1.12 6.35-1.46 7.37L-4 15h1.5v7H3z"/></svg>'); }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-title {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stat-change {
            display: flex;
            align-items: center;
            font-size: 14px;
            gap: 5px;
        }
        
        .stat-change.positive {
            color: #28a745;
        }
        
        .stat-change.negative {
            color: #dc3545;
        }
        
        .stat-change .arrow {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }
        
        .stat-change.positive .arrow {
            border-bottom: 6px solid #28a745;
        }
        
        .stat-change.negative .arrow {
            border-top: 6px solid #dc3545;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .chart-period {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .tables-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .table-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table tbody tr:hover {
            background-color: #fafafa;
            transition: background-color 0.2s ease;
        }
        
        .product-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .product-image {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #eee;
        }
        
        .product-name {
            font-weight: 500;
            color: #333;
        }
        
        .quantity-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .revenue-amount {
            font-weight: 600;
            color: #28a745;
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                padding: 15px;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Dashboard</h1>
            <div class="date-range-picker">
                <select id="timePeriod">
                    <option value="today">Hôm nay</option>
                    <option value="week">7 ngày qua</option>
                    <option value="month" selected>30 ngày qua</option>
                    <option value="quarter">3 tháng qua</option>
                    <option value="year">Năm nay</option>
                </select>
                <button onclick="refreshData()" class="btn btn-primary btn-sm">
                    <i class="fa fa-refresh"></i> Làm mới
                </button>
            </div>
        </div>
        
        <!-- Thống kê tổng quan -->
        <div class="stats-grid">
            <div class="stat-card revenue">
                <div class="stat-header">
                    <div class="stat-title">Tổng doanh thu</div>
                </div>
                <div class="stat-value" id="tongDoanhThu">₫0</div>
                <div class="stat-change positive" id="doanhThuChange">
                    <div class="arrow"></div>
                    <span>+0% so với tháng trước</span>
                </div>
            </div>
            
            <div class="stat-card orders">
                <div class="stat-header">
                    <div class="stat-title">Tổng đơn hàng</div>
                </div>
                <div class="stat-value" id="tongDonHang">0</div>
                <div class="stat-change positive" id="donHangChange">
                    <div class="arrow"></div>
                    <span>+0% so với tháng trước</span>
                </div>
            </div>
            
            <div class="stat-card products">
                <div class="stat-header">
                    <div class="stat-title">Sản phẩm</div>
                </div>
                <div class="stat-value" id="tongSanPham">0</div>
                <div class="stat-change positive" id="sanPhamChange">
                    <div class="arrow"></div>
                    <span>Tổng sản phẩm trong kho</span>
                </div>
            </div>
            
            <div class="stat-card customers">
                <div class="stat-header">
                    <div class="stat-title">Khách hàng</div>
                </div>
                <div class="stat-value" id="tongKhachHang">0</div>
                <div class="stat-change positive" id="khachHangChange">
                    <div class="arrow"></div>
                    <span>+0% khách hàng mới</span>
                </div>
            </div>
        </div>
        
        <!-- Biểu đồ -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Doanh thu theo thời gian</h3>
                    <span class="chart-period">30 ngày qua</span>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Trạng thái đơn hàng</h3>
                    <span class="chart-period">Hiện tại</span>
                </div>
                <div class="chart-container">
                    <canvas id="orderStatusChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Bảng dữ liệu -->
        <div class="tables-grid">
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">Top sản phẩm bán chạy</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>Đã bán</th>
                            <th>Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody id="topSanPhamBanChay">
                        <!-- Dữ liệu sẽ được load bằng JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">Đơn hàng gần đây</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Giá trị</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="donHangGanDay">
                        <!-- Dữ liệu sẽ được load bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Biến global
        let revenueChart, orderStatusChart;
        
        // Load dữ liệu khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            initCharts();
        });
        
        // Hàm load dữ liệu dashboard
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/thong-ke');
                const data = await response.json();
                
                // Cập nhật các thống kê tổng quan
                updateStats(data);
                updateTopProducts(data.topSanPhamBanChay || []);
                updateRecentOrders(data.donHangGanDay || []);
                updateCharts(data);
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                showEmptyState();
            }
        }
        
        // Cập nhật thống kê tổng quan
        function updateStats(data) {
            document.getElementById('tongDoanhThu').textContent = 
                new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' })
                .format(data.tongDoanhThu || 0);
            
            document.getElementById('tongDonHang').textContent = 
                (data.tongDonHang || 0).toLocaleString('vi-VN');
            
            document.getElementById('tongSanPham').textContent = 
                (data.tongSanPham || 0).toLocaleString('vi-VN');
            
            document.getElementById('tongKhachHang').textContent = 
                (data.tongKhachHang || 0).toLocaleString('vi-VN');
        }
        
        // Cập nhật top sản phẩm bán chạy
        function updateTopProducts(products) {
            const tbody = document.getElementById('topSanPhamBanChay');
            
            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <i class="fa fa-shopping-bag"></i>
                            <div>Chưa có dữ liệu sản phẩm</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
                        tbody.innerHTML = products.slice(0, 5).map(product => `
                <tr>
                    <td>
                        <div class="product-info">
                                                        <img src="${product.imageUrl || '/images/no-image.jpg'}" alt="Product" class="product-image">
                            <div class="product-name">${product.tenSanPham || 'Sản phẩm'}</div>
                        </div>
                    </td>
                    <td>
                        <span class="quantity-badge">${(product.soLuongBan || 0).toLocaleString('vi-VN')}</span>
                    </td>
                    <td>
                        <span class="revenue-amount">
                                                        ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' })
                                                            .format(product.doanhThu || 0)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        // Cập nhật đơn hàng gần đây
        function updateRecentOrders(orders) {
            const tbody = document.getElementById('donHangGanDay');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fa fa-shopping-cart"></i>
                            <div>Chưa có đơn hàng nào</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = orders.slice(0, 5).map(order => `
                <tr>
                    <td><strong>${order.maHoaDon || 'N/A'}</strong></td>
                    <td>${order.tenKhachHang || 'Khách vãng lai'}</td>
                    <td class="revenue-amount">
                        ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' })
                          .format(order.tongTien || 0)}
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(order.trangThai)}">
                            ${getStatusText(order.trangThai)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        // Khởi tạo biểu đồ
        function initCharts() {
            // Biểu đồ doanh thu
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Doanh thu',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + 'đ';
                                }
                            }
                        }
                    }
                }
            });
            
            // Biểu đồ trạng thái đơn hàng
            const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
            orderStatusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Chờ xử lý', 'Đã xác nhận', 'Đang giao', 'Hoàn thành', 'Đã hủy'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#ffc107',
                            '#007bff', 
                            '#17a2b8',
                            '#28a745',
                            '#dc3545'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Cập nhật biểu đồ
        function updateCharts(data) {
            // Cập nhật biểu đồ doanh thu (dữ liệu giả lập)
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (6 - i));
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            });
            
            const revenueData = Array.from({length: 7}, () => 
                Math.floor(Math.random() * 10000000) + 1000000
            );
            
            revenueChart.data.labels = last7Days;
            revenueChart.data.datasets[0].data = revenueData;
            revenueChart.update();
            
            // Cập nhật biểu đồ trạng thái đơn hàng (dữ liệu giả lập)
            const statusData = [
                Math.floor(Math.random() * 50) + 10,  // Chờ xử lý
                Math.floor(Math.random() * 30) + 5,   // Đã xác nhận
                Math.floor(Math.random() * 20) + 3,   // Đang giao
                Math.floor(Math.random() * 100) + 50, // Hoàn thành
                Math.floor(Math.random() * 15) + 2    // Đã hủy
            ];
            
            orderStatusChart.data.datasets[0].data = statusData;
            orderStatusChart.update();
        }
        
        // Hàm helper
        function getStatusClass(status) {
            const statusClasses = {
                0: 'status-pending',
                1: 'status-confirmed', 
                2: 'status-shipping',
                3: 'status-completed',
                4: 'status-cancelled',
                5: 'status-paid'
            };
            return statusClasses[status] || 'status-pending';
        }
        
        function getStatusText(status) {
            const statusTexts = {
                0: 'Chờ xử lý',
                1: 'Đã xác nhận',
                2: 'Đang giao', 
                3: 'Hoàn thành',
                4: 'Đã hủy',
                5: 'Đã thanh toán'
            };
            return statusTexts[status] || 'Chờ xử lý';
        }
        
        function showEmptyState() {
            document.getElementById('tongDoanhThu').textContent = '₫0';
            document.getElementById('tongDonHang').textContent = '0';
            document.getElementById('tongSanPham').textContent = '0';
            document.getElementById('tongKhachHang').textContent = '0';
        }
        
        function refreshData() {
            loadDashboardData();
        }
        
        // CSS cho status badge
        const style = document.createElement('style');
        style.textContent = `
            .status-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
            }
            .status-pending { background-color: #fff3cd; color: #856404; }
            .status-confirmed { background-color: #cce5ff; color: #004085; }
            .status-shipping { background-color: #d4edda; color: #155724; }
            .status-completed { background-color: #d1ecf1; color: #0c5460; }
            .status-cancelled { background-color: #f8d7da; color: #721c24; }
            .status-paid { background-color: #d4edda; color: #155724; }
        `;
        document.head.appendChild(style);
    </script>
</div>
</body>
</html>
