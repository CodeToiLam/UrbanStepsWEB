<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout-admin}">
<head>
    <title th:text="${title}">Chi tiết đơn hàng</title>
    <link rel="stylesheet" th:href="@{/css/admin-order-detail.css}">
</head>

<body>
<div layout:fragment="content">
    <div class="order-detail">
        <div class="back-button">
            <a th:if="${param.back}" th:href="${param.back[0]}" class="btn btn-secondary">
                <i class="fa fa-arrow-left"></i> Quay lại
            </a>
            <a th:unless="${param.back}" href="/admin/quan-ly-don-hang" class="btn btn-secondary">
                <i class="fa fa-arrow-left"></i> Quay lại danh sách
            </a>
        </div>

        <!-- Thông báo -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Header đơn hàng -->
        <div class="order-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Chi tiết đơn hàng</h1>
                    <h2 th:text="${order.maHoaDon}" style="color: #007bff; margin: 5px 0;">HD001</h2>
                </div>
                <div>
                    <span class="status-badge"
                          th:classappend="${order.trangThai == 0} ? 'status-pending' :
                                          (${order.trangThai == 1} ? 'status-confirmed' :
                                          (${order.trangThai == 2} ? 'status-shipping' :
                                          (${order.trangThai == 3} ? 'status-completed' :
                                          (${order.trangThai == 4} ? 'status-cancelled' : 'status-paid'))))"
                          th:text="${order.trangThaiText}">Chờ xử lý</span>
                </div>
            </div>
        </div>

        <!-- Timeline trạng thái -->
        <div class="info-section" th:unless="${order.trangThai == 4}">
            <h3>Tiến trình đơn hàng</h3>
            <div class="status-timeline">
                <div class="timeline-line"></div>

                <div class="timeline-item">
                    <div class="timeline-dot" th:classappend="${order.trangThai == 0 or order.trangThai == 1 or order.trangThai == 2 or order.trangThai == 3} ? ' active' : ' inactive'">1</div>
                    <div class="timeline-label">Chờ xử lý</div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot" th:classappend="${order.trangThai == 1 or order.trangThai == 2 or order.trangThai == 3} ? ' active' : ' inactive'">2</div>
                    <div class="timeline-label">Đã xác nhận</div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot" th:classappend="${order.trangThai == 2 or order.trangThai == 3} ? ' active' : ' inactive'">3</div>
                    <div class="timeline-label">Đang giao</div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-dot" th:classappend="${order.trangThai == 3} ? ' active' : ' inactive'">4</div>
                    <div class="timeline-label">Hoàn thành</div>
                </div>
            </div>
        </div>

        <div class="info-section" th:if="${order.trangThai == 4}">
            <h3>Trạng thái đơn hàng</h3>
            <div style="text-align: center; padding: 20px;">
                <div class="timeline-dot cancelled" style="margin: 0 auto 10px;">✗</div>
                <div style="color: #dc3545; font-weight: bold;">Đơn hàng đã bị hủy</div>
            </div>
        </div>

        <!-- Thông tin đơn hàng -->
        <div class="order-info-grid">
            <!-- Thông tin khách hàng -->
            <div class="info-section">
                <h3>Thông tin khách hàng</h3>
                <div class="info-row">
                    <span class="info-label">Họ tên:</span>
                    <span class="info-value" th:text="${order.khachHang.hoTenKhachHang}">Nguyễn Văn A</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Số điện thoại:</span>
                    <span class="info-value" th:text="${order.khachHang.sdt}">0123456789</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value" th:text="${order.khachHang.email != null ? order.khachHang.email : 'Không có'}">example@email.com</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Loại khách:</span>
                    <span class="info-value" th:text="${order.khachHang.laKhachVangLai} ? 'Khách vãng lai' : 'Khách hàng thành viên'">Thành viên</span>
                </div>
                <div class="info-row" th:if="${order.diaChiGiaoHang}">
                    <span class="info-label">Địa chỉ giao hàng:</span>
                    <span class="info-value" th:text="${order.diaChiGiaoHang}" style="white-space: pre-wrap;">123 Đường ABC, Quận 1, TP.HCM</span>
                </div>
                <div class="info-row" th:if="${order.khachHang.taiKhoan}">
                    <span class="info-label">Tài khoản:</span>
                    <span class="info-value" th:text="${order.khachHang.taiKhoan.taiKhoan}">username</span>
                </div>
                <div class="info-row" th:if="${order.khachHang.diaChi}">
                    <span class="info-label">Địa chỉ mặc định:</span>
                    <span class="info-value" th:text="${order.khachHang.diaChi}" style="white-space: pre-wrap;">Địa chỉ khách hàng</span>
                </div>
            </div>

            <!-- Thông tin đơn hàng -->
            <div class="info-section">
                <h3>Thông tin đơn hàng</h3>
                <div class="info-row">
                    <span class="info-label">Ngày tạo:</span>
                    <span class="info-value" th:text="${#temporals.format(order.createAt, 'dd/MM/yyyy HH:mm:ss')}">01/01/2024 10:00:00</span>
                </div>
                <div class="info-row" th:if="${order.updateAt != null and order.updateAt != order.createAt}">
                    <span class="info-label">Cập nhật lần cuối:</span>
                    <span class="info-value" th:text="${#temporals.format(order.updateAt, 'dd/MM/yyyy HH:mm:ss')}">01/01/2024 10:30:00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phương thức thanh toán:</span>
                    <span class="info-value" th:text="${order.phuongThucThanhToanText}">Tiền mặt</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tổng tiền hàng:</span>
                    <span class="info-value" th:text="${#numbers.formatDecimal(order.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'" style="color: #007bff; font-weight: bold;">500,000 VNĐ</span>
                </div>
                <div class="info-row" th:if="${order.tienGiam != null and order.tienGiam > 0}">
                    <span class="info-label">Giảm giá:</span>
                    <span class="info-value" th:text="${'-' + #numbers.formatDecimal(order.tienGiam, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'" style="color: #dc3545;">-50,000 VNĐ</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tổng thanh toán:</span>
                    <span class="info-value" th:text="${#numbers.formatDecimal(order.tongThanhToan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'" style="color: #007bff; font-size: 18px; font-weight: bold;">480,000 VNĐ</span>
                </div>
                <div class="info-row" th:if="${order.ghiChu}">
                    <span class="info-label">Ghi chú:</span>
                    <span class="info-value" th:text="${order.ghiChu}" style="white-space: pre-wrap;">Giao hàng nhanh</span>
                </div>
                <div class="info-row" th:if="${order.tienMat != null and order.tienMat > 0}">
                    <span class="info-label">Tiền mặt:</span>
                    <span class="info-value" th:text="${#numbers.formatDecimal(order.tienMat, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">500,000 VNĐ</span>
                </div>
                <div class="info-row" th:if="${order.tienChuyenKhoan != null and order.tienChuyenKhoan > 0}">
                    <span class="info-label">Chuyển khoản:</span>
                    <span class="info-value" th:text="${#numbers.formatDecimal(order.tienChuyenKhoan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">500,000 VNĐ</span>
                </div>
            </div>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="order-items">
            <h3>Sản phẩm trong đơn hàng</h3>
            <div class="table-responsive">
                <table class="items-table">
                    <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Giá bán</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                        <th style="width:260px;">Hoàn trả</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item : ${order.hoaDonChiTietList}">
                        <td>
                            <div class="product-info">
                                <img class="product-image"
                                     th:src="${item.sanPhamChiTiet != null and item.sanPhamChiTiet.sanPham != null and item.sanPhamChiTiet.sanPham.idHinhAnhDaiDien != null and item.sanPhamChiTiet.sanPham.idHinhAnhDaiDien.duongDan != null} ?
                                             ${item.sanPhamChiTiet.sanPham.idHinhAnhDaiDien.duongDan} :
                                             @{/images/no-image.jpg}"
                                     alt="Product Image">
                                <div>
                                    <div><strong th:text="${item.tenSanPham}">Sản phẩm</strong></div>
                                    <div class="product-attributes">
                                        <span th:if="${item.sanPhamChiTiet != null and item.sanPhamChiTiet.mauSac != null}"
                                              th:text="${'Màu: ' + item.sanPhamChiTiet.mauSac.tenMauSac}">Màu</span>
                                        <span th:if="${item.sanPhamChiTiet != null and item.sanPhamChiTiet.kichCo != null}"> |
                                            <span th:text="${'Size: ' + item.sanPhamChiTiet.kichCo.tenKichCo}">Size</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="price" th:text="${#numbers.formatDecimal(item.giaBan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">1,000,000 VNĐ</td>
                        <td class="quantity" th:text="${item.soLuong}">1</td>
                        <td class="price" th:text="${#numbers.formatDecimal(item.thanhTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">1,000,000 VNĐ</td>
                        <td>
                            <form th:action="@{/admin/order/refund-item}" method="post" style="display:flex; gap:8px; align-items:center;" title="Nhập số lượng cần hoàn của dòng này">
                                <input type="hidden" name="orderId" th:value="${order.id}" />
                                <input type="hidden" name="orderItemId" th:value="${item.id}" />
                                <input type="number" name="quantity" min="1" th:attr="${'max=' + item.soLuong}" th:value="${item.soLuong}" style="width:80px; padding:6px;" placeholder="SL" />
                                <input type="text" name="note" placeholder="Ghi chú (lý do hoàn)" style="flex:1; padding:6px;" />
                                <button type="submit" class="btn btn-danger" onclick="return confirmRefundItem();">Hoàn</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">Tổng tiền:</td>
                        <td class="price total-row" th:text="${#numbers.formatDecimal(order.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">1,000,000 VNĐ</td>
                        <td></td>
                    </tr>
                    <tr th:if="${order.tienGiam != null and order.tienGiam > 0}">
                        <td colspan="3" style="text-align: right; font-weight: bold;">Giảm giá:</td>
                        <td class="price" style="color: #dc3545;" th:text="${'-' + #numbers.formatDecimal(order.tienGiam, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">-100,000 VNĐ</td>
                        <td></td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="3" style="text-align: right; font-weight: bold; font-size: 16px;">Tổng thanh toán:</td>
                        <td class="price" style="font-size: 16px; color: #007bff;" th:text="${#numbers.formatDecimal(order.tongThanhToan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">900,000 VNĐ</td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Thao tác với đơn hàng -->
        <div class="status-actions">
            <h3>Thao tác</h3>
            <div class="d-flex gap-2 flex-wrap">
                <button th:if="${order.trangThai == 0}"
                        class="btn btn-success"
                        th:onclick="|updateOrderStatus(${order.id}, 1)|">
                    <i class="fa fa-check"></i> Xác nhận đơn hàng
                </button>

                <button th:if="${order.trangThai == 1}"
                        class="btn btn-warning"
                        th:onclick="|updateOrderStatus(${order.id}, 2)|">
                    <i class="fa fa-truck"></i> Chuyển sang đang giao
                </button>

                <button th:if="${order.trangThai == 2}"
                        class="btn btn-success"
                        th:onclick="|updateOrderStatus(${order.id}, 3)|">
                    <i class="fa fa-check-circle"></i> Hoàn thành đơn hàng
                </button>

                <!-- Nút hủy đơn hàng - Admin có thể hủy bất kỳ đơn hàng nào (trừ đã hủy) -->
                <form th:if="${order.trangThai != 4}"
                      th:action="@{/admin/order/cancel/{id}(id=${order.id})}"
                      method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger" onclick="return confirmCancelOrder()">
                        <i class="fa fa-times"></i> Hủy đơn
                    </button>
                </form>

                <!-- Nút trả hàng toàn bộ -->
                <form th:action="@{/admin/order/return-all}" method="post" style="display:inline;">
                    <input type="hidden" name="orderId" th:value="${order.id}">
                    <input type="hidden" name="note" value="Trả hàng toàn bộ từ màn hình quản trị">
                    <button type="submit" class="btn btn-warning" onclick="return confirmReturnAll()">
                        <i class="fa fa-undo"></i> Trả hàng toàn bộ
                    </button>
                </form>
            </div>

            <p style="color: #666; font-size: 14px; margin: 10px 0 0;">
                Thao tác này sẽ cập nhật trạng thái đơn hàng và không thể hoàn tác.
            </p>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:src="@{/js/admin-order-detail.js}"></script>
</th:block>
</body>
</html>
